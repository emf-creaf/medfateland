---
title: "Evaluation of watershed-level runoff with river gauge data"
author: "Miquel De Cáceres / María González"
date: "`r Sys.Date()`"
description: >
   Benchmark evaluation at watershed level using gauge data from Aiguadora watershed
output: 
  rmarkdown::html_document:
    df_print: paged
    toc: TRUE
---

```{r setup, include=FALSE}
library(kableExtra)
library(sf)
library(knitr)
library(medfate)
library(ggplot2)
library(cowplot)
library(hydroGOF)
evalDIR = "~/OneDrive/mcaceres_work/model_development/medfate_evaluation/WatershedLevelEvaluation/"
```

## Introduction

### Goal

The aim of this article is to provide an assessment of the performance of `spwb_land()` for the prediction of forest dynamics in Catalonia (NE of Spain). To this aim, we simulate forest dynamics between surveys of the Spanish National Forest Inventory and compare the model predictions of forest development against inventory data for a set of permanent plots. The evaluation focuses first on the growth (in diameter and height) of surviving trees, then turning the attention to the basal area of dead trees and overall changes in terms of basal area and density. Then, we evaluate changes in stand leaf area index and, finally, changes in shrub cover and mean shrub height. 


### Simulation procedure

## Evaluation

```{r, echo = FALSE}
medfateland_ver <- packageVersion("medfateland")
medfateland_ver <- "2.4.6"

aiguadora_unc <- readRDS(file.path(evalDIR, "data", medfateland_ver, "uncalibrated.rds"))
aiguadora_cal <- readRDS(file.path(evalDIR, "data", medfateland_ver, "calibrated.rds"))

Q_Aiguadora <- read.delim("~/OneDrive/mcaceres_work/model_development/medfate_evaluation/WatershedLevelEvaluation/data-raw/Aforo_Aiguadora.txt") |>
  dplyr::mutate(Date = as.Date(Date, format = "%d/%m/%Y")) |>
  dplyr::rename(Qobs = "Aforo..m3.s.") |>
  dplyr::filter(Date >= as.Date("2000-01-01") & Date <= as.Date("2022-12-31"))
Q_Aiguadora$Qunc <- rowSums(aiguadora_unc$outlet_export_m3s)
Q_Aiguadora$Qcal <- rowSums(aiguadora_cal$outlet_export_m3s)

Q_Aiguadora_month <- Q_Aiguadora |>
  dplyr::mutate(Month = cut(Date, breaks="month")) |>
  dplyr::group_by(Month) |>
  dplyr::summarise(Qobs = mean(Qobs, na.rm = TRUE),
                   Qunc = mean(Qunc, na.rm = T),
                   Qcal = mean(Qcal, na.rm = T)) |>
  dplyr::mutate(Month = as.Date(Month))
```

### Graphical evaluation

```{r, echo = FALSE, fig = TRUE, fig.width=8, fig.height = 4, warning=FALSE}
ggplot(Q_Aiguadora, aes(x=Date))+
  geom_line(aes(y = Qobs), col = "black", linewidth = 0.8)+
  geom_line(aes(y = Qunc), col = "red")+
  geom_line(aes(y = Qcal), col = "blue")+
  scale_y_continuous("Q (m3/s)")+
  theme_bw()
```

```{r, echo = FALSE, fig = TRUE, fig.width=8, fig.height = 4, warning=FALSE}
ggplot(Q_Aiguadora_month, aes(x=Month))+
  geom_line(aes(y = Qobs), col = "black", linewidth = 0.8)+
  geom_line(aes(y = Qunc), col = "red")+
  geom_line(aes(y = Qcal), col = "blue")+
  scale_y_continuous("Q (m3/s)")+
  theme_bw()
```

### Goodness-of-fit statistics

The following indices are calculated using package hydroGOF:

+ Nash-Sutcliffe Efficiency (NSE): This coefficient is sensitive to extreme values and might yield sub-optimal results when the dataset contains large outliers.
+ Kling–Gupta efficiency (KGE): Provides a decomposition of the Nash-Sutcliffe efficiency, which facilitates the analysis of the importance of different components (bias, correlation and variability).
+ Index of agreement (d): Initially proposed by Willmott (1981) to overcome the drawbacks of the R2, such as the differences in observed and predicted means and variances (Legates and McCabe, 1999). d is also dimensionless and bounded between 0 and 1 and can be interpreted similarly to R2.
+ Volumetric efficiency index (VE): Originally proposed by Criss and Winston (2008) to circumvent some of the NSE flaws. VE values are also bounded [0, 1] and represent the fraction of water delivered at the proper time

```{r, echo = FALSE}
# Daily NSE
nse_daily_unc<-hydroGOF::NSE(Q_Aiguadora$Qunc,Q_Aiguadora$Qobs,na.rm=TRUE)
nse_daily_cal<-hydroGOF::NSE(Q_Aiguadora$Qcal,Q_Aiguadora$Qobs,na.rm=TRUE)

# Monthly NSE
nse_monthly_unc<-hydroGOF::NSE(Q_Aiguadora_month$Qunc,Q_Aiguadora_month$Qobs,na.rm=TRUE)
nse_monthly_cal<-hydroGOF::NSE(Q_Aiguadora_month$Qcal,Q_Aiguadora_month$Qobs,na.rm=TRUE)

# Daily KGE
KGE_daily_unc<-hydroGOF::KGE(Q_Aiguadora$Qunc,Q_Aiguadora$Qobs, s=c(1,1,1), na.rm=TRUE, method=c("2021"), 
                             out.type=c("full"), fun=NULL, 
                             epsilon.type=c("none"), 
                             epsilon.value=NA)
KGE_daily_cal<-hydroGOF::KGE(Q_Aiguadora$Qcal,Q_Aiguadora$Qobs, s=c(1,1,1), na.rm=TRUE, method=c("2021"), 
                             out.type=c("full"), fun=NULL, 
                             epsilon.type=c("none"), 
                             epsilon.value=NA)

# Monthly KGE
KGE_monthly_unc<-hydroGOF::KGE(Q_Aiguadora_month$Qunc,Q_Aiguadora_month$Qobs, s=c(1,1,1), na.rm=TRUE, method=c("2021"), 
                             out.type=c("full"), fun=NULL, 
                             epsilon.type=c("none"), 
                             epsilon.value=NA)
KGE_monthly_cal<-hydroGOF::KGE(Q_Aiguadora_month$Qcal,Q_Aiguadora_month$Qobs, s=c(1,1,1), na.rm=TRUE, method=c("2021"), 
                             out.type=c("full"), fun=NULL, 
                             epsilon.type=c("none"), 
                             epsilon.value=NA)

# Index of agreement
d_daily_unc<-hydroGOF::dr(Q_Aiguadora$Qunc,Q_Aiguadora$Qobs, na.rm = TRUE)
d_daily_cal<-hydroGOF::dr(Q_Aiguadora$Qcal,Q_Aiguadora$Qobs, na.rm = TRUE)

d_monthly_unc<-hydroGOF::dr(Q_Aiguadora_month$Qunc,Q_Aiguadora_month$Qobs, na.rm = TRUE)
d_monthly_cal<-hydroGOF::dr(Q_Aiguadora_month$Qcal,Q_Aiguadora_month$Qobs, na.rm = TRUE)

# Volumetric efficiency
ve_daily_unc<-hydroGOF::VE(Q_Aiguadora$Qunc,Q_Aiguadora$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
ve_daily_cal<-hydroGOF::VE(Q_Aiguadora$Qcal,Q_Aiguadora$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)

ve_monthly_unc<-hydroGOF::VE(Q_Aiguadora_month$Qunc,Q_Aiguadora_month$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
ve_monthly_cal<-hydroGOF::VE(Q_Aiguadora_month$Qcal,Q_Aiguadora_month$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)

# RMSE
rmse_daily_unc<-hydroGOF::rmse(Q_Aiguadora$Qunc,Q_Aiguadora$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
rmse_daily_cal<-hydroGOF::rmse(Q_Aiguadora$Qcal,Q_Aiguadora$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
rmse_monthly_unc<-hydroGOF::rmse(Q_Aiguadora_month$Qunc,Q_Aiguadora_month$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
rmse_monthly_cal<-hydroGOF::rmse(Q_Aiguadora_month$Qcal,Q_Aiguadora_month$Qobs, na.rm=TRUE, fun=NULL,
                       epsilon.type=c("none"), epsilon.value=NA)
```


```{r, echo = FALSE}

validation_coefficients<- data.frame(Scale = c("Daily", "Daily", "Monthly", "Monthly"),
                                     Calibration =  c("Before","After","Before","After"),
                                     NSE = NA,
                                     KGE = NA,
                                     d = NA,
                                     VE = NA,
                                     RMSE = NA)

validation_coefficients$NSE[1]<-nse_daily_unc
validation_coefficients$NSE[2]<-nse_daily_cal
validation_coefficients$NSE[3]<-nse_monthly_unc
validation_coefficients$NSE[4]<-nse_monthly_cal

validation_coefficients$KGE[1]<-KGE_daily_unc[["KGE.value"]]
validation_coefficients$KGE[2]<-KGE_daily_cal[["KGE.value"]]
validation_coefficients$KGE[3]<-KGE_monthly_unc[["KGE.value"]]
validation_coefficients$KGE[4]<-KGE_monthly_cal[["KGE.value"]]

validation_coefficients$d[1]<-d_daily_unc
validation_coefficients$d[2]<-d_daily_cal
validation_coefficients$d[3]<-d_monthly_unc
validation_coefficients$d[4]<-d_monthly_cal

validation_coefficients$VE[1]<-ve_daily_unc
validation_coefficients$VE[2]<-ve_daily_cal
validation_coefficients$VE[3]<-ve_monthly_unc
validation_coefficients$VE[4]<-ve_monthly_cal

validation_coefficients$RMSE[1]<-rmse_daily_unc
validation_coefficients$RMSE[2]<-rmse_daily_cal
validation_coefficients$RMSE[3]<-rmse_monthly_unc
validation_coefficients$RMSE[4]<-rmse_monthly_cal

validation_coefficients |> 
  kbl() |>
  kable_styling()
```




### Hydrological analysis

TO BE DONE

