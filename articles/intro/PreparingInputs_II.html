<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Preparing inputs II: arbitrary locations • medfateland</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Preparing inputs II: arbitrary locations">
<meta name="description" content="Instructions to create model inputs in a set of arbitrary locations
">
<meta property="og:description" content="Instructions to create model inputs in a set of arbitrary locations
">
<meta property="og:image" content="https://emf-creaf.github.io/medfateland/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">medfateland</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../../articles/intro/PackageOverview.html">Package overview</a></li>
    <li><a class="dropdown-item" href="../../articles/intro/PreparingInputs_I.html">Preparing inputs I: forest inventory plots</a></li>
    <li><a class="dropdown-item" href="../../articles/intro/PreparingInputs_II.html">Preparing inputs II: arbitrary locations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Running simulations</h6></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/SpatiallyUncoupledSimulations.html">Spatially-uncoupled simulations</a></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/WatershedSimulations.html">Watershed simulations</a></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/ManagementScenarios.html">Management scenarios</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emf-creaf/medfateland/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Preparing inputs II: arbitrary locations</h1>
                        <h4 data-toc-skip class="author">Miquel De
Cáceres / Núria Aquilué / Paula Martín / María González</h4>
            
            <h4 data-toc-skip class="date">2025-03-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emf-creaf/medfateland/blob/HEAD/vignettes/intro/PreparingInputs_II.Rmd" class="external-link"><code>vignettes/intro/PreparingInputs_II.Rmd</code></a></small>
      <div class="d-none name"><code>PreparingInputs_II.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="aim">Aim<a class="anchor" aria-label="anchor" href="#aim"></a>
</h2>
<p>This vignette has been created to illustrate the creation of spatial
inputs to be used in model simulations with the package, starting
<strong>from a set of coordinates</strong> corresponding to
<strong>arbitrary locations</strong>. The functions introduced in this
document are meant to be executed sequentially to progressively add
spatial information, as illustrated in the workflow below, but users are
free to use them in the most convenient way.</p>
<p><img src="Landscape_init_workflow.png" alt="Initialisation workflow for continuous landscapes" width="90%" style="display: block; margin: auto;"></p>
<p>Before reading this vignette, users should be familiar with
<em>forest</em> and <em>soil</em> structures in package
<strong>medfate</strong>. Moreover, a brief introduction to spatial
structures used in <strong>medfateland</strong> package is given in
vignette <a href="https://emf-creaf.github.io/medfateland/articles/PackageOverview.html">Package
overview</a> and examples are given in vignettes <a href="https://emf-creaf.github.io/medfateland/articles/SpatiallyUncoupledSimulations.html">Spatially-uncoupled
simulations</a> and <a href="https://emf-creaf.github.io/medfateland/articles/WatershedSimulations.html">Watershed
simulations</a>.</p>
<p>Let’s first load necessary libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://emf-creaf.github.io/medfate/" class="external-link">medfate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://emf-creaf.github.io/medfateland/">medfateland</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="target-area">Target area<a class="anchor" aria-label="anchor" href="#target-area"></a>
</h2>
<p>Any spatial data set should begin with the definition of spatial
elements. Here we will use a watershed in Catalonia as example, which we
will describe using cells of 200 m in EPSG:32631 (UTM for fuse 31)
projection.</p>
<p>First we load a polygon data set describing watersheds in Spain and
select our target watershed (Riera de Bianya [river code
“2005528”]):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataset_path</span> <span class="op">&lt;-</span> <span class="st">"~/OneDrive/EMF_datasets/"</span></span>
<span><span class="va">scchh</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Hydrography/Sources/Spain/CuencasMedNorte_Pfafs/M_cuencas_rios_Med_Norte.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">watershed</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">scchh</span><span class="op">[</span><span class="va">scchh</span><span class="op">$</span><span class="va">pfafrio</span> <span class="op">==</span><span class="st">"2005528"</span>,<span class="op">]</span>, <span class="st">"epsg:25831"</span><span class="op">)</span></span>
<span><span class="va">watershed</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 1, 8  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : 444922.8, 459850.8, 4668354, 4678487  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">##  names       : OBJECTID COD_MAR cod_uni pfafrio       nom_rio_1 Cuen_Tipo</span></span>
<span><span class="co">##  type        :    &lt;int&gt;   &lt;chr&gt;   &lt;int&gt;   &lt;chr&gt;           &lt;chr&gt;     &lt;chr&gt;</span></span>
<span><span class="co">##  values      :    63564       M 1001395 2005528 RIERA DE BIANYA        NA</span></span>
<span><span class="co">##  Shape_Leng Shape_Area</span></span>
<span><span class="co">##       &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">##   4.905e+04  1.024e+08</span></span></code></pre>
<p>We can draw a map with the location of the watershed within Catalonia
using:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataset_path</span> <span class="op">&lt;-</span> <span class="st">"~/OneDrive/EMF_datasets/"</span></span>
<span><span class="va">counties</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"PoliticalBoundaries/Sources/Catalunya/Comarques/comarques.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-4-1.png" alt="Location of the watershed within Catalonia" width="480" style="display: block; margin: auto;"></p>
<p>Now we define a raster at 200 m resolution, including the target
area. We intersect it with the watershed boundaries to keep the target
locations:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">watershed</span><span class="op">)</span>, resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">res</span>,<span class="va">res</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">"epsg:25831"</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/intersect.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.points.html" class="external-link">as.points</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="va">watershed</span><span class="op">)</span></span></code></pre></div>
<p>And finally we transform the result into a <code>sf</code>
object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">[</span>,<span class="st">"geometry"</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="va">x</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2573 features and 0 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.4 ymin: 4668453 xmax: 459751.3 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##                    geometry</span></span>
<span><span class="co">## 1  POINT (449799.3 4678387)</span></span>
<span><span class="co">## 2  POINT (449998.3 4678387)</span></span>
<span><span class="co">## 3  POINT (450197.4 4678387)</span></span>
<span><span class="co">## 4  POINT (450396.4 4678387)</span></span>
<span><span class="co">## 5  POINT (450595.5 4678387)</span></span>
<span><span class="co">## 6  POINT (450794.5 4678387)</span></span>
<span><span class="co">## 7  POINT (449401.2 4678189)</span></span>
<span><span class="co">## 8  POINT (449600.3 4678189)</span></span>
<span><span class="co">## 9  POINT (449799.3 4678189)</span></span>
<span><span class="co">## 10 POINT (449998.3 4678189)</span></span></code></pre>
<p>We will use the raster definition for plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span><span class="co">## Ncells 2108966 112.7    4276820 228.5  2603706 139.1</span></span>
<span><span class="co">## Vcells 3546505  27.1   10146329  77.5 10144745  77.4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="topography-and-land-cover-type">Topography and land cover type<a class="anchor" aria-label="anchor" href="#topography-and-land-cover-type"></a>
</h2>
<p><strong>Topography</strong></p>
<p>Once an object <code>sf</code> has been defined with target
locations, we need to determine topographic features (elevation, slope,
aspect) and land cover corresponding to those locations. You should have
access to a Digital Elevation Model (DEM) at a desired resolution. Here
we will use a DEM raster for Catalonia at 30 m resolution, which we load
using package <code>terra</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Topography/Products/Catalunya/MET30m_ETRS89_UTM31_ICGC.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dem</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 9282, 9391, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 30, 30  (x, y)</span></span>
<span><span class="co">## extent      : 258097.5, 539827.5, 4485488, 4763948  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : MET30m_ETRS89_UTM31_ICGC.tif </span></span>
<span><span class="co">## name        : met15v20as0f0118Bmr1r050 </span></span>
<span><span class="co">## min value   :                   -7.120 </span></span>
<span><span class="co">## max value   :                 3133.625</span></span></code></pre>
<p>Having a digital elevation model, we can use function
<code><a href="../../reference/add_topography.html">add_topography()</a></code> to extract elevation and calculate aspect
and slope:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/add_topography.html">add_topography</a></span><span class="op">(</span><span class="va">x</span>, dem <span class="op">=</span> <span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking inputs</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Checking inputs <span style="color: #B2B2B2;">[14ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Defining column 'id'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Defining column 'id' <span style="color: #B2B2B2;">[11ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Extracting topography</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Extracting topography <span style="color: #B2B2B2;">[7.2s]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_0</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2573 features and 4 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.4 ymin: 4668453 xmax: 459751.3 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,573 × 5</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (449799.3 4678387)     1      900.  24.5   164.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449998.3 4678387)     2      901.  27.5   155.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (450197.4 4678387)     3      880.  23.2   146.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (450396.4 4678387)     4      843.  27.9   201.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450595.5 4678387)     5      878.  16.9   158.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450794.5 4678387)     6      860.  22.4   188.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (449401.2 4678189)     7      995.  20.9   180.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (449600.3 4678189)     8      938.  30.8   107.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (449799.3 4678189)     9      838.  19.6   140.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (449998.3 4678189)    10      831.  27.3   101.</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,563 more rows</span></span></span></code></pre>
<p>We can check that there are no missing values in topographic features
using:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_topography</a></span><span class="op">(</span><span class="va">y_0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing values in topography.</span></span></code></pre>
<p>We can now examine the elevation of the area, using the raster
<code>r</code> to draw cells instead of points:</p>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-12-1.png" alt="Elevation map" width="576"></p>
<p><strong>Land cover type</strong></p>
<p>In addition to topography, users should have access to a land cover
map, in this case we will use a land cover raster for Catalonia, issued
in 2018:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lcm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"LandCover/Sources/Catalunya/cobertes-sol-v1r0-2018.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lcm</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 259198, 267234, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">## extent      : 260170, 527404, 4488784, 4747982  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : cobertes-sol-v1r0-2018.tif </span></span>
<span><span class="co">## color table : 1 </span></span>
<span><span class="co">## name        : cobertes-sol-v1r0-2018</span></span></code></pre>
<p>Users should examine the legend of their land cover map and decide
how to map legend elements to the five land cover types used in
<strong>medfateland</strong>. After inspecting our land cover map
legend, we define the following vectors to perform the legend
mapping:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agriculture</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="va">wildland</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span><span class="op">:</span><span class="fl">17</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">rock</span> <span class="op">&lt;-</span> <span class="fl">18</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">artificial</span> <span class="op">&lt;-</span> <span class="fl">21</span><span class="op">:</span><span class="fl">35</span></span>
<span><span class="va">water</span> <span class="op">&lt;-</span> <span class="fl">36</span><span class="op">:</span><span class="fl">41</span></span></code></pre></div>
<p>Having these inputs, we can use <code><a href="../../reference/add_topography.html">add_land_cover()</a></code> to add
land cover to our starting <code>sf</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/add_topography.html">add_land_cover</a></span><span class="op">(</span><span class="va">y_0</span>, </span>
<span>                      land_cover_map <span class="op">=</span> <span class="va">lcm</span>, </span>
<span>                      wildland <span class="op">=</span> <span class="va">wildland</span>, </span>
<span>                      agriculture <span class="op">=</span> <span class="va">agriculture</span>, </span>
<span>                      rock <span class="op">=</span> <span class="va">rock</span>, </span>
<span>                      artificial <span class="op">=</span> <span class="va">artificial</span>, </span>
<span>                      water <span class="op">=</span> <span class="va">water</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">y_1</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2573 features and 5 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.4 ymin: 4668453 xmax: 459751.3 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,573 × 6</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (449799.3 4678387)     1      900.  24.5   164. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449998.3 4678387)     2      901.  27.5   155. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (450197.4 4678387)     3      880.  23.2   146. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (450396.4 4678387)     4      843.  27.9   201. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450595.5 4678387)     5      878.  16.9   158. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450794.5 4678387)     6      860.  22.4   188. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (449401.2 4678189)     7      995.  20.9   180. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (449600.3 4678189)     8      938.  30.8   107. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (449799.3 4678189)     9      838.  19.6   140. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (449998.3 4678189)    10      831.  27.3   101. wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,563 more rows</span></span></span></code></pre>
<p>As before, we can check for missing data:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_land_cover</a></span><span class="op">(</span><span class="va">y_1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing values in land cover.</span></span></code></pre>
<p>We can examine the land cover types in our target area using:</p>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-18-1.png" alt="Land cover map" width="576"></p>
</div>
<div class="section level2">
<h2 id="forest-parameterization">Forest parameterization<a class="anchor" aria-label="anchor" href="#forest-parameterization"></a>
</h2>
<p>The next step is to define <code>forest</code> objects for our
simulations. Forests should be defined for all target locations whose
land cover is defined as <code>wildland</code>. When forest inventory
plots are not be available for the target locations, one must resort on
imputations.</p>
<ol style="list-style-type: decimal">
<li>Forest inventory data from nearby locations. National forest
inventories are ideal in this respect.</li>
<li>A forest map where polygons or raster cells describe the
distribution of forest (or shrubland) types.</li>
<li>Raster source of vegetation structure (i.e. mean tree height or
basal area), derived from aerial or satellite LiDAR missions.</li>
</ol>
<p>Our task here will be to perform imputations of forest inventory
plots to our target locations according to some criteria and, if
possible, to correct the forest structure on those locations according
to available data.</p>
<div class="section level3">
<h3 id="forest-imputation">Forest imputation<a class="anchor" aria-label="anchor" href="#forest-imputation"></a>
</h3>
<p>A map of forest types in the target area is important to determine
dominant tree or shrub species. We start by loading the <a href="https://www.miteco.gob.es/en/biodiversidad/temas/inventarios-nacionales/mapa-forestal-espana/mfe_25.html" class="external-link">Spanish
Forest Map (1:25000)</a> for the region of Catalonia, which is in vector
format, using package <code>terra</code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"ForestMaps/Products/Catalunya/mfe25_cat_class.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forest_map</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 238096, 1  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : 0.1591812, 3.332506, 40.523, 42.86144  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  source      : mfe25_cat_class.shp</span></span>
<span><span class="co">##  coord. ref. : lon/lat ETRS89 (EPSG:4258) </span></span>
<span><span class="co">##  names       :              Class</span></span>
<span><span class="co">##  type        :              &lt;chr&gt;</span></span>
<span><span class="co">##  values      : Pinus halepensis_2</span></span>
<span><span class="co">##                Pinus halepensis_2</span></span>
<span><span class="co">##                Pinus halepensis_2</span></span></code></pre>
<p>Second, we need forest inventory data for imputations. Arguably, this
is the hardest part. Let’s assume one has access to a such data already
in format for package <em>medfateland</em> (how to build such data set
will be illustrated in a different vignette). We also load an
<code>sf_nfi</code> object that contains coordinates and forest objects
corresponding to the <a href="https://www.miteco.gob.es/es/biodiversidad/temas/inventarios-nacionales/inventario-forestal-nacional/cuarto_inventario.html" class="external-link">Fourth
Spanish Forest Inventory</a> for Catalonia (5509 forest plots):</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nfi_path</span> <span class="op">&lt;-</span> <span class="st">"/home/miquel/OneDrive/mcaceres_work/model_initialisation/medfate_initialisation/IFN2medfate/"</span></span>
<span><span class="va">sf_nfi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">nfi_path</span>, <span class="st">"data/SpParamsMED/IFN4/Catalunya/IFN4_cat_final_ETRS89H31.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf_nfi</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 5509 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 260943 ymin: 4491797 xmax: 518928 ymax: 4744883</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 5,509 × 15</span></span></span>
<span><span class="co">##    Provincia Estadillo Clase Subclase IDPARCELA IDCLASE ID       id    elevation</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 08        0001      A     1        080001    A1      080001_… 0800…      <span style="text-decoration: underline;">1</span>814</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 08        0002      A     1        080002    A1      080002_… 0800…      <span style="text-decoration: underline;">1</span>797</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 08        0003      A     1        080003    A1      080003_… 0800…      <span style="text-decoration: underline;">1</span>657</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 08        0004      A     1        080004    A1      080004_… 0800…      <span style="text-decoration: underline;">1</span>403</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 08        0005      A     1        080005    A1      080005_… 0800…      <span style="text-decoration: underline;">1</span>371</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 08        0006      A     1        080006    A1      080006_… 0800…      <span style="text-decoration: underline;">1</span>683</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 08        0009      A     4        080009    A4      080009_… 0800…      <span style="text-decoration: underline;">1</span>041</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 08        0014      A     1        080014    A1      080014_… 0800…      <span style="text-decoration: underline;">1</span>538</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 08        0016      A     4        080016    A4      080016_… 0800…      <span style="text-decoration: underline;">1</span>743</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 08        0020      A     1        080020    A1      080020_… 0800…      <span style="text-decoration: underline;">1</span>404</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5,499 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 6 more variables: slope &lt;dbl&gt;, aspect &lt;dbl&gt;, soil &lt;list&gt;, forest &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   forest_allrecords &lt;named list&gt;, geom &lt;POINT [m]&gt;</span></span></span></code></pre>
<p>Note that this is already an <code>sf</code> object suitable for
simulations, but refers to the locations of the forest inventory plots,
not to our target area.</p>
<p>Having these two inputs (forest map and forest inventory data), we
can use function <code><a href="../../reference/forest_parametrization.html">impute_forests()</a></code> to perform the imputation
for us (this normally takes some time):</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/forest_parametrization.html">impute_forests</a></span><span class="op">(</span><span class="va">y_1</span>, sf_fi <span class="op">=</span> <span class="va">sf_nfi</span>, dem <span class="op">=</span> <span class="va">dem</span>, </span>
<span>                      forest_map <span class="op">=</span> <span class="va">forest_map</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## |---------|---------|---------|---------|=========================================                                          </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> 8 forest classes were not represented in forest inventory data. Geographic/topographic criteria used for 103 target locations.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Forest imputed on 2018 out of 2161 target wildland locations (93.4%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Forest class was missing for 143 locations and forests were not imputed there.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Not enough plots of the same class within geographic distance limits for 19 locations. The closest plot of the same class was chosen in those cases.</span></span></code></pre>
<p>For each target location, the function selects forest inventory plots
that correspond to the same forest class, defined in the forest map, and
are geographically closer than a pre-specified maximum distance. Among
the multiple plots that can fulfill this criterion, the function chooses
the plot that has the most similar elevation and position in the N-to-S
slopes (i.e. the product of the cosine of aspect and slope). More
details can be found in the documentation of
<code><a href="../../reference/forest_parametrization.html">impute_forests()</a></code>.</p>
<p>The resulting <code>sf</code> has an extra column named
<code>forest</code>:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2573 features and 6 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.4 ymin: 4668453 xmax: 459751.3 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,573 × 7</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (449799.3 4678387)     1      900.  24.5   164. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449998.3 4678387)     2      901.  27.5   155. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (450197.4 4678387)     3      880.  23.2   146. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (450396.4 4678387)     4      843.  27.9   201. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450595.5 4678387)     5      878.  16.9   158. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450794.5 4678387)     6      860.  22.4   188. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (449401.2 4678189)     7      995.  20.9   180. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (449600.3 4678189)     8      938.  30.8   107. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (449799.3 4678189)     9      838.  19.6   140. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (449998.3 4678189)    10      831.  27.3   101. wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,563 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 1 more variable: forest &lt;list&gt;</span></span></span></code></pre>
<p>Only <code>wildland</code> locations will have a <code>forest</code>
object, for example:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##             Species      DBH   Height         N      Z50  Z95</span></span>
<span><span class="co">## 1      Quercus ilex 29.65000 670.0000  14.14711 702.5790 5020</span></span>
<span><span class="co">## 2      Quercus ilex 24.09090 676.0889  28.29421 702.5790 5020</span></span>
<span><span class="co">## 3      Quercus ilex 19.74620 633.1792  63.66198 702.5790 5020</span></span>
<span><span class="co">## 4 Quercus pubescens 19.35000 890.0000  31.83099 647.0011 4510</span></span>
<span><span class="co">## 5      Quercus ilex 15.23560 595.8797 350.14088 702.5790 5020</span></span>
<span><span class="co">## 6 Quercus pubescens 14.27765 874.6080  63.66198 647.0011 4510</span></span>
<span><span class="co">## 7      Quercus ilex 11.16919 502.2300 381.97186 702.5790 5020</span></span>
<span><span class="co">## 8      Quercus ilex  5.00000 300.0000 381.97186 702.5790 5020</span></span>
<span><span class="co">## 9      Quercus ilex  1.50000 100.0000 318.30989 702.5790 5020</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##              Species Cover Height       Z50  Z95</span></span>
<span><span class="co">## 1 Buxus sempervirens    15    200 218.54095 1100</span></span>
<span><span class="co">## 2       Genista spp.    10     50 143.90556  639</span></span>
<span><span class="co">## 3  Globularia alypum     2     10  47.19721  150</span></span>
<span><span class="co">## 4  Helianthemum spp.     2     10 133.39433  579</span></span>
<span><span class="co">## 5      Teucrium spp.     1     10  68.62047  244</span></span>
<span><span class="co">## 6        Thymus spp.     5     10 110.82153  455</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
<p>It is important to know whether the forest inputs are complete and
suitable for simulations. This can be done using function
<code><a href="../../reference/check_inputs.html">check_forests()</a></code>:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_forests</a></span><span class="op">(</span><span class="va">y_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Missing 'forest' data in 143 wildland locations (6.6%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> All objects in column 'forest' have the right class.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing/wrong values detected in key tree/shrub attributes of 'forest' objects.</span></span></code></pre>
<p>There are some <em>wildland</em> locations missing forest data. These
correspond to shrublands or pastures, therefore not included in the
forest inventory data. At this point, we could call again
<code><a href="../../reference/forest_parametrization.html">impute_forests()</a></code> including the option
<code>missing_class_imputation = TRUE</code>, which would force
imputation of forest inventory plots on non-forest cells. The
alternative is to provide more suitable data.</p>
</div>
<div class="section level3">
<h3 id="shrubland-imputation">Shrubland imputation<a class="anchor" aria-label="anchor" href="#shrubland-imputation"></a>
</h3>
<p>In this section we illustrate how to use function
<code>impute_forest()</code> to impute <code>forest</code> objects in
shrubland areas. To this aim, we use a vegetation map representing
habitats of interest for the EU: <a href="https://agricultura.gencat.cat/ca/serveis/cartografia-sig/bases-cartografiques/habitats/habitats-catalunya/" class="external-link"><em>Hàbitats
d’interès comunitari</em></a>:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">veg_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"ForestMaps/Sources/Catalunya/Habitats_v2/Habitats_interes_com.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">veg_map</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 61036, 42  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : 260189, 526577.9, 4488766, 4747981  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  source      : Habitats_interes_com.shp</span></span>
<span><span class="co">##  coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">##  names       :  OBJECTID  HIC1       TEXT_HIC1 RHIC1 SUP_HIC1  HIC2</span></span>
<span><span class="co">##  type        :     &lt;num&gt; &lt;chr&gt;           &lt;chr&gt; &lt;num&gt;    &lt;num&gt; &lt;chr&gt;</span></span>
<span><span class="co">##  values      : 4.218e+04  9340 Alzinars i car~    10     4.17    NA</span></span>
<span><span class="co">##                2.444e+04  9340 Alzinars i car~     5    23.56  9540</span></span>
<span><span class="co">##                 2.09e+04  9260     Castanyedes     4     5.02    NA</span></span>
<span><span class="co">##        TEXT_HIC2 RHIC2 SUP_HIC2  HIC3 (and 32 more)</span></span>
<span><span class="co">##            &lt;chr&gt; &lt;num&gt;    &lt;num&gt; &lt;chr&gt;              </span></span>
<span><span class="co">##               NA     0        0    NA              </span></span>
<span><span class="co">##  Pinedes medite~     5    23.56    NA              </span></span>
<span><span class="co">##               NA     0        0    NA</span></span></code></pre>
<p>In this case we use a database of 575 shrubland inventory plots in
Catalonia described in <a href="https://doi.org/10.1186/s13595-023-01190-y" class="external-link">Casals et
al. (2023)</a>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sfi_path</span> <span class="op">&lt;-</span> <span class="st">"/home/miquel/OneDrive/mcaceres_work/model_initialisation/medfate_initialisation/Shrublands/Combuscat/"</span></span>
<span><span class="va">sf_sfi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sfi_path</span>, <span class="st">"Products/Combuscat_final.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf_sfi</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 546 features and 6 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 267500 ymin: 4495400 xmax: 519300 ymax: 4736800</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 546 × 7</span></span></span>
<span><span class="co">##                geom    id elevation slope aspect soil         forest      </span></span>
<span><span class="co">##         <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;named list&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (345200 4574000)     5     619.  11.3     105 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (368600 4582600)     7     695.   1.15      5 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (362800 4586000)    24     533.   8.53    255 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (366000 4567200)    25     274.  16.7     235 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (349500 4576800)    29     536.  11.3      70 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (346400 4574000)    38     707.   0       110 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (498000 4687400)   107      73.0 14.0     340 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (389500 4571800)   315     378.   6.84     63 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (390200 4571400)   318     367.   8.53     12 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (394400 4572800)   330     200.   0         0 <span style="color: #949494;">&lt;df [4 × 6]&gt;</span> <span style="color: #949494;">&lt;forest [4]&gt;</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 536 more rows</span></span></span></code></pre>
<p>We now call again <code><a href="../../reference/forest_parametrization.html">impute_forests()</a></code> with this
information. Unless we force it, the function will not overwrite those
<code>forest</code> objects already present in <code>y_2</code>. On the
other hand, we will assume that any wildland location not classified as
forest or shrubland should correspond to pastures. Hence, in this case
we will ask the function to make imputations in locations with missing
vegetation class (<code>missing_class_imputation = TRUE</code>) and
define a empty forest to be imputed in those
(<code>missing_class_forest = emptyforest()</code>):</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/forest_parametrization.html">impute_forests</a></span><span class="op">(</span><span class="va">y_2</span>, sf_fi <span class="op">=</span> <span class="va">sf_sfi</span>, dem <span class="op">=</span> <span class="va">dem</span>, </span>
<span>                      forest_map <span class="op">=</span> <span class="va">veg_map</span>, </span>
<span>                      var_class <span class="op">=</span> <span class="st">"TEXT_HIC1"</span>,</span>
<span>                      missing_class_imputation <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                      missing_class_forest <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/emptyforest.html" class="external-link">emptyforest</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                      progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## |---------|---------|---------|---------|=========================================                                          </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> 8 forest classes were not represented in forest inventory data. Geographic/topographic criteria used for 65 target locations.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Forest imputed on 143 out of 143 target wildland locations (100%).</span></span></code></pre>
<p>We call again function <code><a href="../../reference/check_inputs.html">check_forests()</a></code> to verify that
there are no wildland cells without a <code>forest</code> object
defined:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_forests</a></span><span class="op">(</span><span class="va">y_3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No wildland locations with NULL values in column 'forest'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> All objects in column 'forest' have the right class.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing/wrong values detected in key tree/shrub attributes of 'forest' objects.</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="structure-correction">Structure correction<a class="anchor" aria-label="anchor" href="#structure-correction"></a>
</h3>
<p>The forests resulting from imputation are formally fine for
simulations, but the forest structure in the target locations can be
very different than that of the forest inventory used as reference, even
if the forest types are the same. Therefore, it is advisable to correct
the forest structure with available information.</p>
<p>There are several global products made recently available, that
combine satellite LiDAR observations with other information, such as <a href="https://doi.org/10.1029/2011JG001708" class="external-link">Simard et al. (2011)</a>, <a href="https://doi.org/10.1016/j.rse.2020.112165" class="external-link">Potapov et
al. (2021)</a> or <a href="https://doi.org/10.1038/s41559-023-02206-6" class="external-link">Lang et
al. (2023)</a>. Alternatively, airborne LiDAR products are available for
some countries and regions. Here we will use <a href="https://www.icgc.cat/ca/Geoinformacio-i-mapes/Mapes/Mapes-de-variables-biofisiques-de-larbrat-de-Catalunya" class="external-link">biophysical
structural maps</a> derived from LiDAR flights in Catalonia (years
2016-2017). First we will load a mean tree height raster at 20-m
resolution:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"RemoteSensing/Sources/Catalunya/Lidar/VariablesBiofisiques/RastersComplets/2016-2017/variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">height_map</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 13100, 13400, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 20, 20  (x, y)</span></span>
<span><span class="co">## extent      : 260000, 528000, 4488000, 4750000  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017.tif </span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017</span></span></code></pre>
<p>This resolution is a bit finer than the size of forest inventory
plots. Hence, we aggregate the raster to the 40m resolution, while we
crop to the target area:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map_40</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">height_map</span>, <span class="va">r</span><span class="op">)</span>, </span>
<span>                                  fact <span class="op">=</span> <span class="fl">2</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">height_map_40</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 253, 374, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 40, 40  (x, y)</span></span>
<span><span class="co">## extent      : 444920, 459880, 4668360, 4678480  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017 </span></span>
<span><span class="co">## min value   :                                                3.965 </span></span>
<span><span class="co">## max value   :                                               25.000</span></span></code></pre>
<p>Mean tree height data has the following distribution:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">height_map_40</span><span class="op">)</span><span class="op">&lt;-</span> <span class="st">"height"</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">height</span><span class="op">)</span>, data<span class="op">=</span><span class="va">height_map_40</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m"</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-35-1.png" alt="Tree height map derived from LiDAR" width="576"></p>
<p>We now call function <code><a href="../../reference/forest_parametrization.html">modify_forest_structure()</a></code> to
correct mean tree height according to the LiDAR data (Note the
correction of units: tree heights are in cm in
<strong>medfate</strong>):</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map_40_cm</span> <span class="op">&lt;-</span> <span class="va">height_map_40</span><span class="op">*</span><span class="fl">100</span></span>
<span><span class="va">y_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/forest_parametrization.html">modify_forest_structure</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="va">height_map_40_cm</span>, var <span class="op">=</span> <span class="st">"mean_tree_height"</span>,</span>
<span>                               progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Correction of tree heights also affects tree diameters, because the
function assumes that the diameter-height relationship needs to be
preserved. If we inspect the same <code>forest</code> object again, we
will be able to note changes in height and diameter values:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_4</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##             Species       DBH    Height         N      Z50  Z95</span></span>
<span><span class="co">## 1      Quercus ilex 49.850533 1126.4707  14.14711 702.5790 5020</span></span>
<span><span class="co">## 2      Quercus ilex 40.504013 1136.7080  28.29421 702.5790 5020</span></span>
<span><span class="co">## 3      Quercus ilex 33.199282 1064.5640  63.66198 702.5790 5020</span></span>
<span><span class="co">## 4 Quercus pubescens 32.533147 1496.3566  31.83099 647.0011 4510</span></span>
<span><span class="co">## 5      Quercus ilex 25.615603 1001.8524 350.14088 702.5790 5020</span></span>
<span><span class="co">## 6 Quercus pubescens 24.005005 1470.4780  63.66198 647.0011 4510</span></span>
<span><span class="co">## 7      Quercus ilex 18.778757  844.3991 381.97186 702.5790 5020</span></span>
<span><span class="co">## 8      Quercus ilex  8.406498  504.3899 381.97186 702.5790 5020</span></span>
<span><span class="co">## 9      Quercus ilex  2.521949  168.1300 318.30989 702.5790 5020</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##              Species Cover Height       Z50  Z95</span></span>
<span><span class="co">## 1 Buxus sempervirens    15    200 218.54095 1100</span></span>
<span><span class="co">## 2       Genista spp.    10     50 143.90556  639</span></span>
<span><span class="co">## 3  Globularia alypum     2     10  47.19721  150</span></span>
<span><span class="co">## 4  Helianthemum spp.     2     10 133.39433  579</span></span>
<span><span class="co">## 5      Teucrium spp.     1     10  68.62047  244</span></span>
<span><span class="co">## 6        Thymus spp.     5     10 110.82153  455</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
<p>Additionally, one may have access to other maps of structural
variables. In our case, we will use a raster of basal area, also derived
from LiDAR flights:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basal_area_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"RemoteSensing/Sources/Catalunya/Lidar/VariablesBiofisiques/RastersComplets/2016-2017/variables-biofisiques-arbrat-v1r0-ab-2016-2017.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">basal_area_map</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 13100, 13400, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 20, 20  (x, y)</span></span>
<span><span class="co">## extent      : 260000, 528000, 4488000, 4750000  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : variables-biofisiques-arbrat-v1r0-ab-2016-2017.tif </span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-ab-2016-2017</span></span></code></pre>
<p>We perform the same aggregation done for heights:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basal_area_map_40</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">basal_area_map</span>, <span class="va">r</span><span class="op">)</span>, </span>
<span>                                      fact <span class="op">=</span> <span class="fl">2</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">basal_area_map_40</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 253, 374, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 40, 40  (x, y)</span></span>
<span><span class="co">## extent      : 444920, 459880, 4668360, 4678480  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-ab-2016-2017 </span></span>
<span><span class="co">## min value   :                                           3.48 </span></span>
<span><span class="co">## max value   :                                          60.00</span></span></code></pre>
<p>Basal area geographic distribution looks as follows:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">&lt;-</span> <span class="st">"basal_area"</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">basal_area</span><span class="op">)</span>, data<span class="op">=</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m2/ha"</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-41-1.png" alt="Basal area map derived from LiDAR" width="576"></p>
<p>We now use the same function to correct basal area values (no unit
conversion is needed in this case):</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/forest_parametrization.html">modify_forest_structure</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="va">basal_area_map_40</span>, var <span class="op">=</span> <span class="st">"basal_area"</span>,</span>
<span>                               progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Note that basal area (or tree density) corrections should be done
after the height correction, because of the effect that height
correction has on tree diameters. The correction of basal area operates
on tree density values. As before, we can inspect changes in tree
density:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_5</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##             Species       DBH    Height         N      Z50  Z95</span></span>
<span><span class="co">## 1      Quercus ilex 49.850533 1126.4707  10.26564 702.5790 5020</span></span>
<span><span class="co">## 2      Quercus ilex 40.504013 1136.7080  20.53128 702.5790 5020</span></span>
<span><span class="co">## 3      Quercus ilex 33.199282 1064.5640  46.19538 702.5790 5020</span></span>
<span><span class="co">## 4 Quercus pubescens 32.533147 1496.3566  23.09769 647.0011 4510</span></span>
<span><span class="co">## 5      Quercus ilex 25.615603 1001.8524 254.07461 702.5790 5020</span></span>
<span><span class="co">## 6 Quercus pubescens 24.005005 1470.4780  46.19538 647.0011 4510</span></span>
<span><span class="co">## 7      Quercus ilex 18.778757  844.3991 277.17230 702.5790 5020</span></span>
<span><span class="co">## 8      Quercus ilex  8.406498  504.3899 277.17230 702.5790 5020</span></span>
<span><span class="co">## 9      Quercus ilex  2.521949  168.1300 230.97692 702.5790 5020</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##              Species Cover Height       Z50  Z95</span></span>
<span><span class="co">## 1 Buxus sempervirens    15    200 218.54095 1100</span></span>
<span><span class="co">## 2       Genista spp.    10     50 143.90556  639</span></span>
<span><span class="co">## 3  Globularia alypum     2     10  47.19721  150</span></span>
<span><span class="co">## 4  Helianthemum spp.     2     10 133.39433  579</span></span>
<span><span class="co">## 5      Teucrium spp.     1     10  68.62047  244</span></span>
<span><span class="co">## 6        Thymus spp.     5     10 110.82153  455</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
<p>To finish this section, we will show the effect of imputation and
correction on structural variables, compared with the LiDAR data.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"a) Imputation"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"b) Imputation + H correction"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_5</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"c) Imputation + H/BA correction"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_vect</span><span class="op">$</span><span class="va">basal_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">basal_area_map_40</span>, <span class="va">x_vect</span><span class="op">)</span><span class="op">$</span><span class="va">basal_area</span></span>
<span><span class="va">r_ba</span><span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">x_vect</span>, <span class="va">r</span>, field <span class="op">=</span> <span class="st">"basal_area"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">last</span><span class="op">)</span>, data<span class="op">=</span><span class="va">r_ba</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"d) Basal area from LiDAR"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span>, nrow <span class="op">=</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-44-1.png" alt="Effect of imputation, height correction and basal area correction on basal area over the study area" width="768"></p>
<p>where it is apparent that both the height correction and the basal
area correction have an effect in basal area. Correcting only for height
is not satisfactory in terms of basal area, because of the modification
of diameters (without correcting density). Note that the map after the
two corrections differs from the LiDAR basal area in locations that have
not been corrected because of missing LiDAR values (or missing tree
data). We can quantitatively assess the relationship between predicted
basal area and the observed one using:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ba_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">extract_variables</a></span><span class="op">(</span><span class="va">y_5</span>, <span class="st">"basal_area"</span><span class="op">)</span><span class="op">$</span><span class="va">basal_area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">ba_5</span>, <span class="va">x_vect</span><span class="op">$</span><span class="va">basal_area</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  ba_5 and x_vect$basal_area</span></span>
<span><span class="co">## t = 94.329, df = 2061, p-value &lt; 2.2e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.8926294 0.9088864</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##      cor </span></span>
<span><span class="co">## 0.901074</span></span></code></pre>
<p>We can also see the effect of the imputation and correction on mean
tree height:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"a) Imputation"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"b) Imputation + H mean_tree_height"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_5</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"c) Imputation + H/BA correction"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">height_map_40_cm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_vect</span><span class="op">$</span><span class="va">height</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">height_map_40_cm</span>, <span class="va">x_vect</span><span class="op">)</span><span class="op">$</span><span class="va">height</span></span>
<span><span class="va">r_ba</span><span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">x_vect</span>, <span class="va">r</span>, field <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">last</span><span class="op">)</span>, data<span class="op">=</span><span class="va">r_ba</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"d) Mean tree height from LiDAR"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span>, nrow <span class="op">=</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-46-1.png" alt="Effect of imputation, mean tree height correction and basal area correction on mean tree height" width="768"></p>
<p>Here the basal area correction did not have any effect on mean tree
height. The relationship between estimated and predicted mean tree
height is:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mth_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">extract_variables</a></span><span class="op">(</span><span class="va">y_5</span>, <span class="st">"mean_tree_height"</span><span class="op">)</span><span class="op">$</span><span class="va">mean_tree_height</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">mth_5</span>, <span class="va">x_vect</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  mth_5 and x_vect$height</span></span>
<span><span class="co">## t = 95.708, df = 1947, p-value &lt; 2.2e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.9000222 0.9156141</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##       cor </span></span>
<span><span class="co">## 0.9081325</span></span></code></pre>
<p>Finally, we check again that forests are well-defined, using function
<code><a href="../../reference/check_inputs.html">check_forests()</a></code>:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_forests</a></span><span class="op">(</span><span class="va">y_5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No wildland locations with NULL values in column 'forest'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> All objects in column 'forest' have the right class.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing/wrong values detected in key tree/shrub attributes of 'forest' objects.</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="soil-parameterization">Soil parameterization<a class="anchor" aria-label="anchor" href="#soil-parameterization"></a>
</h2>
<p>Soil information is most usually lacking for the target locations.
Regional maps of soil properties may be available in some cases. Here we
assume this information is not available, so that we resort to global
products. In particular, we will use information provided in <a href="https://soilgrids.org/" class="external-link">SoilGrids</a> at 250 m resolution (<a href="https://doi.org/10.1371/journal.pone.0169748" class="external-link">Hengl et
al. (2017)</a>; <a href="https://doi.org/10.5194/soil-7-217-2021" class="external-link">Poggio
et al. (2021)</a>).</p>
<div class="section level3">
<h3 id="soilgrids-2-0-data">SoilGrids 2.0 data<a class="anchor" aria-label="anchor" href="#soilgrids-2-0-data"></a>
</h3>
<p>Function <code><a href="../../reference/soil_parametrization.html">add_soilgrids()</a></code> can perform queries using the
REST API of SoilGrids, but this becomes problematic for multiple sites.
Hence, we recommend downloading SoilGrid rasters for the target region
and storing them in a particular format, so that function
<code><a href="../../reference/soil_parametrization.html">add_soilgrids()</a></code> can read them (check the details of the
function documentation). The extraction of SoilGrids data for our target
cells is rather fast using this approach:</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soilgrids_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Soils/Sources/Global/SoilGrids/Spain/"</span><span class="op">)</span></span>
<span><span class="va">y_6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/soil_parametrization.html">add_soilgrids</a></span><span class="op">(</span><span class="va">y_5</span>, soilgrids_path <span class="op">=</span> <span class="va">soilgrids_path</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>And the result has an extra column <code>soil</code>:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_6</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2573 features and 7 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.4 ymin: 4668453 xmax: 459751.3 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,573 × 8</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (449799.3 4678387)     1      900.  24.5   164. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449998.3 4678387)     2      901.  27.5   155. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (450197.4 4678387)     3      880.  23.2   146. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (450396.4 4678387)     4      843.  27.9   201. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450595.5 4678387)     5      878.  16.9   158. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450794.5 4678387)     6      860.  22.4   188. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (449401.2 4678189)     7      995.  20.9   180. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (449600.3 4678189)     8      938.  30.8   107. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (449799.3 4678189)     9      838.  19.6   140. wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (449998.3 4678189)    10      831.  27.3   101. wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,563 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2 more variables: forest &lt;list&gt;, soil &lt;list&gt;</span></span></span></code></pre>
<p>The elements of the list are the usual data frames of soil properties
in <strong>medfate</strong>:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_6</span><span class="op">$</span><span class="va">soil</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   widths clay sand   om   bd  rfc nitrogen</span></span>
<span><span class="co">## 1     50 21.5 38.4 8.69 1.12 18.0     5.16</span></span>
<span><span class="co">## 2    100 21.0 39.2 4.03 1.14 21.2     2.47</span></span>
<span><span class="co">## 3    150 22.7 38.6 2.59 1.27 19.1     1.95</span></span>
<span><span class="co">## 4    300 24.7 38.3 1.87 1.43 17.8     1.16</span></span>
<span><span class="co">## 5    400 25.2 40.0 1.40 1.52 18.2     1.06</span></span>
<span><span class="co">## 6   1000 25.0 39.1 0.88 1.54 19.4     0.97</span></span></code></pre>
<p>During data retrieval, there might be some locations where SoilGrids
2.0 data was missing. We can use function <code><a href="../../reference/check_inputs.html">check_soils()</a></code> to
detect those cases and fill them with default values:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/check_inputs.html">check_soils</a></span><span class="op">(</span><span class="va">y_6</span>, missing_action <span class="op">=</span> <span class="st">"default"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> 81 null 'soil' elements out of 2492 wildland/agriculture locations (3.3%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No wildland/agriculture locations with NULL values in column 'soil'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Default 'clay' values assigned for 20 locations (0.8%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Default 'sand' values assigned for 20 locations (0.8%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Default 'bd' values assigned for 20 locations (0.8%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Default 'rfc' values assigned for 20 locations (0.8%).</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="soil-depth-and-rock-content-modification">Soil depth and rock content modification<a class="anchor" aria-label="anchor" href="#soil-depth-and-rock-content-modification"></a>
</h3>
<p>SoilGrids 2.0 does not provide information on soil depth, and rock
fragment content is normally underestimated, which leads to an
overestimation of water holding capacity. Function
<code><a href="../../reference/soil_parametrization.html">modify_soils()</a></code> allows modifying soil definitions, if
information is available for soil depth, depth to the (unaltered)
bedrock, or both. Soil depth maps are not common in many regions, so
here we will resort on a global product at 250m-resolution by <a href="https://doi.org/10.1002/2016MS000686" class="external-link">Shangguan et al. (2017)</a>,
which consists on three rasters:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Censored soil depth (cm)</span></span>
<span><span class="va">bdricm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDRICM_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Probability of bedrock within first 2m [0-100]</span></span>
<span><span class="va">bdrlog</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDRLOG_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Absolute depth to bedrock (cm)</span></span>
<span><span class="va">bdticm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDTICM_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In order to accelerate raster manipulations, we crop the global
rasters to the extent of the target area:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bdricm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_ext</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">x_vect</span><span class="op">)</span></span>
<span><span class="va">bdricm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdricm</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span>
<span><span class="va">bdrlog</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdrlog</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span>
<span><span class="va">bdticm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdticm</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span></code></pre></div>
<p>Censored soil depth is a poor product of actual soil depth, but we
have observed a fairly good correlation between soil depth values in
Catalonia and the probability of finding the bedrock within the first
two meters. Hence, we multiply the two layers and use it as a (crude)
estimate of soil depth, expressing it in mm:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil_depth_mm</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bdricm</span><span class="op">$</span><span class="va">BDRICM_M_250m_ll</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="va">bdrlog</span><span class="op">$</span><span class="va">BDRLOG_M_250m_ll</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and we take the depth to bedrock as appropriate, but change its units
to mm as well:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">depth_to_bedrock_mm</span> <span class="op">&lt;-</span> <span class="va">bdticm</span><span class="op">*</span><span class="fl">10</span></span></code></pre></div>
<p>We can now call function <code><a href="../../reference/soil_parametrization.html">modify_soils()</a></code> with the two
rasters to perform the correction of soil characteristics:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_8</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/soil_parametrization.html">modify_soils</a></span><span class="op">(</span><span class="va">y_7</span>, </span>
<span>                    soil_depth_map <span class="op">=</span> <span class="va">soil_depth_mm</span>, </span>
<span>                    depth_to_bedrock_map <span class="op">=</span> <span class="va">depth_to_bedrock_mm</span>,</span>
<span>                    progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In this case, the depth to bedrock values were deeper than 2m, so
that only the soil depth map had an effect on the correction procedure.
After the correction, the rock fragment content of the soil has changed
substantially:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_8</span><span class="op">$</span><span class="va">soil</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   widths clay sand   om   bd      rfc nitrogen</span></span>
<span><span class="co">## 1     50 21.5 38.4 8.69 1.12 18.00000     5.16</span></span>
<span><span class="co">## 2    100 21.0 39.2 4.03 1.14 21.20000     2.47</span></span>
<span><span class="co">## 3    150 22.7 38.6 2.59 1.27 19.10000     1.95</span></span>
<span><span class="co">## 4    300 24.7 38.3 1.87 1.43 31.33929     1.16</span></span>
<span><span class="co">## 5    400 25.2 40.0 1.40 1.52 55.71429     1.06</span></span>
<span><span class="co">## 6   1000 25.0 39.1 0.88 1.54 97.50000     0.97</span></span></code></pre>
<p>We can compare the effect of the correction on the soil water
capacity (in mm) by inspecting the following plots (note the change in
magnitude and spatial pattern):</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_7</span>, <span class="st">"soil_vol_extract"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">"mm"</span>, type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"YlGnBu"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"SoilGrids alone"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_8</span>, <span class="st">"soil_vol_extract"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">"mm"</span>, type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"YlGnBu"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"SoilGrids + depth correction"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, ncol <span class="op">=</span><span class="fl">1</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-60-1.png" alt="Extractable soil water volume before and after correcting SoilGrids data" width="672"></p>
<p>Finally, we can call again <code><a href="../../reference/check_inputs.html">check_soils()</a></code> to verify that
everything is fine:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/check_inputs.html">check_soils</a></span><span class="op">(</span><span class="va">y_8</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> 81 null 'soil' elements out of 2492 wildland/agriculture locations (3.3%).</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No wildland/agriculture locations with NULL values in column 'soil'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> No missing values detected in key soil attributes.</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="additional-variables">Additional variables<a class="anchor" aria-label="anchor" href="#additional-variables"></a>
</h2>
<p>In this section we illustrate the estimation of additional variables
that are needed in some occasions. At present, there are no specific
functions in <strong>medfateland</strong> for these variables.</p>
<div class="section level3">
<h3 id="crop-factors-for-agricultural-areas">Crop factors for agricultural areas<a class="anchor" aria-label="anchor" href="#crop-factors-for-agricultural-areas"></a>
</h3>
<p>If there are target locations whose land cover type is
<em>agriculture</em> we should supply a column called
<code>crop_factor</code> in our <code>sf</code> input object, so that
soil water balance can be conducted in agriculture locations. Crop maps
for Europe can be found, for example in <a href="https://doi.org/10.1016/j.rse.2021.112708" class="external-link">d’Andrimont et
al. (2021)</a>. In our case we will use regional data from the Catalan
administration (<a href="https://agricultura.gencat.cat/ca/ambits/desenvolupament-rural/sigpac/mapa-cultius/index.html" class="external-link">Mapa
de cultius</a> from 2018). We start by reading the crop map and
subsetting it to the target area:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_crop_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Agriculture/Sources/Catalunya/Cultius_DUN2018/Cultius_DUN2018.shp"</span><span class="op">)</span></span>
<span><span class="va">crop_map</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">file_crop_map</span>, options <span class="op">=</span> <span class="st">"ENCODING=UTF-8"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## options:        ENCODING=UTF-8 </span></span>
<span><span class="co">## Reading layer `Cultius_DUN2018' from data source </span></span>
<span><span class="co">##   `/home/miquel/OneDrive/EMF_datasets/Agriculture/Sources/Catalunya/Cultius_DUN2018/Cultius_DUN2018.shp' </span></span>
<span><span class="co">##   using driver `ESRI Shapefile'</span></span>
<span><span class="co">## Simple feature collection with 638797 features and 9 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 264864.2 ymin: 4488884 xmax: 523857.3 ymax: 4733681</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span></code></pre>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crop_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">crop_map</span><span class="op">[</span>,<span class="st">"Cultiu"</span><span class="op">]</span><span class="op">)</span>, <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p>Crops in the target watershed, occupy valley bottoms as expected:</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">Cultiu</span><span class="op">)</span>, data<span class="op">=</span><span class="va">crop_map</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-65-1.png" alt="Crop distribution in the study area" width="576"></p>
<p>To obtain our crop factors, we first extract the crop name
corresponding to <em>agriculture</em> locations:</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sel_agr</span> <span class="op">&lt;-</span> <span class="va">y_1</span><span class="op">$</span><span class="va">land_cover_type</span><span class="op">==</span><span class="st">"agriculture"</span></span>
<span><span class="va">x_agr</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">sel_agr</span><span class="op">]</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">crop_map</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_agr_crop</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">crop_map</span>, </span>
<span>                             <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">x_agr</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Some cells may have missing values, specially if the land cover map
and the crop map are not consistent:</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_agr_crop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">x_agr_crop</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df_agr_crop</span><span class="op">$</span><span class="va">Cultiu</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## FALSE  TRUE </span></span>
<span><span class="co">##   191   140</span></span></code></pre>
<p>For simplicity we will assume the missing values correspond to
Ray-grass, the most common crop in the area:</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_agr_crop</span><span class="op">$</span><span class="va">Cultiu</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df_agr_crop</span><span class="op">$</span><span class="va">Cultiu</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"RAY-GRASS"</span></span></code></pre></div>
<p>In order to transform crop names into crop factors, we need a look-up
table, which we prepared for Catalonia</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">crop_lookup_table</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Agriculture/Sources/Catalunya/Kc_CAT_MOD.xlsx"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">crop_lookup_table</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">##   Cultiu_map                  Cultiu_text                 Grup   Asignacio    Kc</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> ALBERCOQUERS                Albercoquer                 FUITA… Albercoq… 0.383</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> ALBERGÍNIA                  Alberginia                  HORTÍ… Albergin… 0.226</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> ALFÀBREGA                   Alfabrega                   ALTRE… Alfabrega 0.1  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> ALFALS NO SIE               Alfals no siega             FARRA… Alfals    0.78 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> ALFALS SIE                  Alfals siega                FARRA… Alfals    0.78 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> ALGARROBA HERBACIA NO SIEGA Algarroba herbacia no siega LLEGU… Mitjana … 0.36</span></span></code></pre>
<p>We join the two tables by the crop name column and get the crop
factor (column <code>Kc</code>):</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_agr_crop</span> <span class="op">&lt;-</span> <span class="va">df_agr_crop</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">crop_lookup_table</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cultiu"</span><span class="op">=</span><span class="st">"Cultiu_map"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y_8</span><span class="op">$</span><span class="va">crop_factor</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">y_8</span><span class="op">$</span><span class="va">crop_factor</span><span class="op">[</span><span class="va">sel_agr</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">df_agr_crop</span><span class="op">$</span><span class="va">Kc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">y_8</span><span class="op">$</span><span class="va">crop_factor</span><span class="op">[</span><span class="va">sel_agr</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.1725  0.5212  1.0000  0.8053  1.0000  1.0000</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="hydrogeology">Hydrogeology<a class="anchor" aria-label="anchor" href="#hydrogeology"></a>
</h3>
<p>Watershed simulations with <code>watershed_model = "tetis"</code>
require defining spatial variables necessary for the simulation of
groundwater flows and aquifer dynamics:</p>
<ul>
<li>
<em>Depth to bedrock</em> [<code>depth_to_bedrock</code>] - Depth to
unweathered bedrock, in mm.</li>
<li>
<em>Bedrock hydraulic conductivity</em>
[<code>bedrock_conductivity</code>] - Hydraulic conductivity of the
bedrock, in m·day-1.</li>
<li>
<em>Bedrock porosity</em> [<code>bedrock_porosity</code>] - Bedrock
porosity (as proportion of volume).</li>
</ul>
<p>As estimate of depth to bedrock, one can use the same variable from
<a href="https://doi.org/10.1002/2016MS000686" class="external-link">Shangguan et
al. (2017)</a>, that we already transformed to mm:</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">y_8</span><span class="op">)</span>, </span>
<span>                                       <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">depth_to_bedrock_mm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y_8</span><span class="op">$</span><span class="va">depth_to_bedrock</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">depth_to_bedrock_mm</span>, <span class="va">x_vect</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span></code></pre></div>
<p>which we can plot using:</p>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-73-1.png" alt="Depth to bedrock from GLHYMPS 2.0" width="576"></p>
<p>If regional maps are not available to inform about permeability and
conductivity, we suggest using the GLobal HYdrogeology MaPS, GLHYMPS 2.0
(<a href="https://doi.org/10.1002/2017GL075860" class="external-link">Huscroft et
al. 2021</a>):</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glhymps_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Soils/Sources/Global/GLHYMPS2/GLHYMPS_Spain.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">glhymps_map</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 18954, 23  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : -556597.5, 445486.2, 3637705, 4410471  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  source      : GLHYMPS_Spain.shp</span></span>
<span><span class="co">##  coord. ref. : Cylindrical_Equal_Area </span></span>
<span><span class="co">##  names       : OBJECTID_1 IDENTITY_ logK_Ice_x logK_Ferr_ Porosity_x K_stdev_x1</span></span>
<span><span class="co">##  type        :      &lt;num&gt;     &lt;chr&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">##  values      :   9.43e+05   ESP3276      -1520      -1520         19        250</span></span>
<span><span class="co">##                  9.43e+05   ESP3282      -1180      -1180          6        150</span></span>
<span><span class="co">##                  9.43e+05   ESP3291      -1180      -1180          6        150</span></span>
<span><span class="co">##  OBJECTID Descriptio    XX    YY (and 13 more)</span></span>
<span><span class="co">##     &lt;num&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;              </span></span>
<span><span class="co">##         0         NA    NA    NA              </span></span>
<span><span class="co">##         0         NA    NA    NA              </span></span>
<span><span class="co">##         0         NA    NA    NA</span></span></code></pre>
<p>We first extract the GLHYMPS 2.0 data on the target locations:</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">y_8</span><span class="op">)</span>, </span>
<span>                                       <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">glhymps_map</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_glhymps</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">glhymps_map</span>, <span class="va">x_vect</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x_glhymps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   id.y OBJECTID_1 IDENTITY_ logK_Ice_x logK_Ferr_ Porosity_x K_stdev_x1</span></span>
<span><span class="co">## 1    1    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">## 2    2    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">## 3    3    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">## 4    4    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">## 5    5    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">## 6    6    1194174   ESP3435      -1520      -1520         19        250</span></span>
<span><span class="co">##   OBJECTID Descriptio   XX   YY   ZZ   AA   DD Shape_Leng GUM_K Prmfrst</span></span>
<span><span class="co">## 1        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">## 2        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">## 3        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">## 4        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">## 5        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">## 6        0       &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;          0     1       0</span></span>
<span><span class="co">##   Shape_Le_1 Shape_Area Transmissi COUNT AREA_1 MEAN STD</span></span>
<span><span class="co">## 1     939134 1701770734          0     0      0    0   0</span></span>
<span><span class="co">## 2     939134 1701770734          0     0      0    0   0</span></span>
<span><span class="co">## 3     939134 1701770734          0     0      0    0   0</span></span>
<span><span class="co">## 4     939134 1701770734          0     0      0    0   0</span></span>
<span><span class="co">## 5     939134 1701770734          0     0      0    0   0</span></span>
<span><span class="co">## 6     939134 1701770734          0     0      0    0   0</span></span></code></pre>
<p>For porosity we simply divide the GLHYMPS 2.0 value by 100 to find
the proportion:</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_8</span><span class="op">$</span><span class="va">bedrock_porosity</span> <span class="op">&lt;-</span> <span class="va">x_glhymps</span><span class="op">[</span>,<span class="st">"Porosity_x"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">/</span><span class="fl">100</span></span></code></pre></div>
<p>Its geographic distribution is quite simple:</p>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_8</span>, <span class="st">"bedrock_porosity"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-78-1.png" alt="Bedrock porosity from GLHYMPS 2.0" width="576"></p>
<p>GLHYMPS 2.0 provides permeability in the log scale, and the following
operations are needed to obtain hydraulic conductivity in m/day:</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Permeability m2</span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="va">x_glhymps</span><span class="op">[</span>,<span class="st">"logK_Ferr_"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co"># Water density kg·m-3</span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">999.97</span> </span>
<span><span class="co"># Gravity m·s-2</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fl">9.8</span></span>
<span><span class="co"># Viscosity of water</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">1e-3</span></span>
<span><span class="co"># Conductivity m/s</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="va">k</span><span class="op">*</span><span class="va">rho</span><span class="op">*</span><span class="va">g</span><span class="op">/</span><span class="va">mu</span></span>
<span><span class="co"># Daily conductivity m/day</span></span>
<span><span class="va">K_day</span> <span class="op">&lt;-</span> <span class="va">K</span><span class="op">*</span><span class="fl">3600</span><span class="op">*</span><span class="fl">24</span></span></code></pre></div>
<p>Finally, we assign the conductivity values to the <code>sf</code>
object:</p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_8</span><span class="op">$</span><span class="va">bedrock_conductivity</span> <span class="op">&lt;-</span> <span class="va">K_day</span></span></code></pre></div>
<p>Its geographic distribution is very simple, again:</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_8</span>, <span class="st">"bedrock_conductivity"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_II_files/figure-html/unnamed-chunk-81-1.png" alt="Bedrock conductivity from GLHYMPS 2.0" width="576"></p>
</div>
<div class="section level3">
<h3 id="other-variables">Other variables<a class="anchor" aria-label="anchor" href="#other-variables"></a>
</h3>
<p>Simulation of management scenarios requires defining additional
variables in the <code>sf</code> object, concerning the area represented
by each location and the management unit to which it belongs. This is
illustrated in vignette <a href="https://emf-creaf.github.io/medfateland/articles/ManagementScenarios.html">Management
scenarios</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="storing">Storing<a class="anchor" aria-label="anchor" href="#storing"></a>
</h2>
<p>At the end of the process of building spatial inputs, we should store
the result as an RDS file, to be loaded at the time of performing
simulations, e.g.</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">y_8</span>, <span class="st">"bianya.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Since the data set corresponds to a watershed, we should also store
the raster:</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">r</span>, <span class="st">"bianya_raster.tif"</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="initialization-test">Initialization test<a class="anchor" aria-label="anchor" href="#initialization-test"></a>
</h2>
<p>We can check whether the input data set is well formed by calling
function <code><a href="../../reference/initialize_landscape.html">initialize_landscape()</a></code>:</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">y_8</span>, <span class="va">SpParamsMED</span>, <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                          progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miquel De Cáceres, Aitor Améztegui, María González, Núria Aquilué, Daniel Caviedes-Voullième, Mario Morales-Hernández.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
