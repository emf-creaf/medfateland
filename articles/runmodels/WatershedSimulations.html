<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Watershed simulations • medfateland</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Watershed simulations">
<meta name="description" content="Learn how to conduct simulations over a watershed with lateral water flows
">
<meta property="og:description" content="Learn how to conduct simulations over a watershed with lateral water flows
">
<meta property="og:image" content="https://emf-creaf.github.io/medfateland/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">medfateland</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.8.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../../articles/intro/PackageOverview.html">Package overview</a></li>
    <li><a class="dropdown-item" href="../../articles/intro/PreparingInputs_I.html">Preparing inputs I: forest inventory plots</a></li>
    <li><a class="dropdown-item" href="../../articles/intro/PreparingInputs_II.html">Preparing inputs II: arbitrary locations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Running simulations</h6></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/SpatiallyUncoupledSimulations.html">Spatially-uncoupled simulations</a></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/WatershedSimulations.html">Watershed simulations</a></li>
    <li><a class="dropdown-item" href="../../articles/runmodels/ManagementScenarios.html">Management scenarios</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emf-creaf/medfateland/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Watershed simulations</h1>
                        <h4 data-toc-skip class="author">Miquel De
Caceres</h4>
            
            <h4 data-toc-skip class="date">2025-10-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/emf-creaf/medfateland/blob/HEAD/vignettes/runmodels/WatershedSimulations.Rmd" class="external-link"><code>vignettes/runmodels/WatershedSimulations.Rmd</code></a></small>
      <div class="d-none name"><code>WatershedSimulations.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="aim">Aim<a class="anchor" aria-label="anchor" href="#aim"></a>
</h2>
<p>The aim of this vignette is to illustrate how to use
<strong>medfateland</strong> (v. 2.8.1) to carry out simulations of
forest function and dynamics on a set of forest stands while including
lateral water transfer processes. This is done using functions
<code><a href="../../reference/spwb_land.html">spwb_land()</a></code>, <code><a href="../../reference/spwb_land.html">growth_land()</a></code> and
<code><a href="../../reference/spwb_land.html">fordyn_land()</a></code>; which are counterparts of functions
<code><a href="https://emf-creaf.github.io/medfate/reference/spwb.html" class="external-link">spwb()</a></code>, <code><a href="https://emf-creaf.github.io/medfate/reference/growth.html" class="external-link">growth()</a></code> and <code><a href="https://emf-creaf.github.io/medfate/reference/fordyn.html" class="external-link">fordyn()</a></code> in
package <strong>medfate</strong>. We will focus here on function
<code><a href="../../reference/spwb_land.html">spwb_land()</a></code>, but the other two functions would be used
similarly. The same can be said for functions
<code><a href="../../reference/spwb_land_day.html">spwb_land_day()</a></code> and <code><a href="../../reference/spwb_land_day.html">growth_land_day()</a></code>, which
are counterparts of <code><a href="https://emf-creaf.github.io/medfate/reference/spwb_day.html" class="external-link">spwb_day()</a></code> and
<code><a href="https://emf-creaf.github.io/medfate/reference/spwb_day.html" class="external-link">growth_day()</a></code>, respectively.</p>
</div>
<div class="section level2">
<h2 id="preparation">Preparation<a class="anchor" aria-label="anchor" href="#preparation"></a>
</h2>
<p>Preparing inputs for watershed simulations can be tedious. Two main
inputs need to be assembled, described in the following two sections
(see also <a href="https://emf-creaf.github.io/medfateland/articles/intro/PreparingInputs_II.html%5D">Preparing
inputs II: arbitrary locations</a>).</p>
<div class="section level3">
<h3 id="input-sf-objects">Input sf objects<a class="anchor" aria-label="anchor" href="#input-sf-objects"></a>
</h3>
<p>Here we load a small example watershed included with the package,
that can be used to understand the inputs required:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_watershed"</span><span class="op">)</span></span>
<span><span class="va">example_watershed</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 15</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 9 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;, crop_factor &lt;dbl&gt;</span></span></span></code></pre>
<p>Some of the columns like <code>forest</code>, <code>soil</code>,
<code>elevation</code>, or <code>state</code>, were also present in the
example for spatially-uncoupled simulations, so we will not repeat them.
The following describes additional columns that are relevant here.</p>
<p><strong>Land cover type</strong></p>
<p>Simulations over watersheds normally include different land cover
types. These are described in column <code>land_cover_type</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">example_watershed</span><span class="op">$</span><span class="va">land_cover_type</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## agriculture        rock    wildland </span></span>
<span><span class="co">##          17           1          48</span></span></code></pre>
<p>Local and landscape processes will behave differently depending on
the land cover type.</p>
<p><strong>Aquifer and snowpack</strong></p>
<p>Columns <code>aquifer</code> and <code>snowpack</code> are used as
state variables to store the water content in the aquifer and snowpack,
respectively.</p>
<p><strong>Crop factors</strong></p>
<p>Since the landscape contains agricultural lands, we need to define
<em>crop factors</em>, which will determine transpiration flow as a
proportion of potential evapotranspiration:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_watershed</span><span class="op">$</span><span class="va">crop_factor</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">example_watershed</span><span class="op">$</span><span class="va">crop_factor</span><span class="op">[</span><span class="va">example_watershed</span><span class="op">$</span><span class="va">land_cover_type</span><span class="op">==</span><span class="st">"agriculture"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.75</span></span></code></pre></div>
<p><strong>Channel network</strong></p>
<p>In large watersheds, the hydrological behavior of the model may not
be appropriate because water routing in the river channel is not
considered. If a binary column called <code>channel</code> is included
in the input, the model will use it to determine the river network,
outlets and the time in days to reach them (see function
<code>overland_routing</code> for a static analysis of channel
routing).</p>
</div>
<div class="section level3">
<h3 id="grid-topology">Grid topology<a class="anchor" aria-label="anchor" href="#grid-topology"></a>
</h3>
<p>Note that the <code>sf</code> structure does not imply a grid <em>per
se</em>. Point geometry is used to describe the central coordinates of
grid cells, but does not describe the grid. This means that another
spatial input is needed to describe the grid topology, which in our case
is an object of class <code>SpatRaster</code> from package
<strong>terra</strong>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">401380</span>, ymin <span class="op">=</span> <span class="fl">4671820</span>, xmax <span class="op">=</span> <span class="fl">402880</span>, ymax <span class="op">=</span> <span class="fl">4672620</span>, </span>
<span>                nrow <span class="op">=</span> <span class="fl">8</span>, ncol <span class="op">=</span> <span class="fl">15</span>, crs <span class="op">=</span> <span class="st">"epsg:32631"</span><span class="op">)</span></span>
<span><span class="va">r</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## size        : 8, 15, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 100, 100  (x, y)</span></span>
<span><span class="co">## extent      : 401380, 402880, 4671820, 4672620  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : WGS 84 / UTM zone 31N (EPSG:32631)</span></span></code></pre>
<p>The <code>r</code> object must have the same coordinate reference
system as the <code>sf</code> object. Moreover, each grid cell can
contain up to one point of the <code>sf</code> (typically at the cell
center). Some grid cells may be empty, though, so that the actual
simulations may be done on an incomplete grid. Note that the raster does
not contain data, only the topology is needed (to define neighbors and
cell sizes, for example). All relevant attribute data is already
included in the <code>sf</code> object.</p>
<p>Combining the <code>r</code> and <code>sf</code> objects allows
drawing rasterized maps:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed</span>, variable <span class="op">=</span> <span class="st">"elevation"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="watershed-control-options">Watershed control options<a class="anchor" aria-label="anchor" href="#watershed-control-options"></a>
</h3>
<p>Analogously to local-scale simulations with <strong>medfate</strong>,
watershed simulations have overall control parameters. Notably, the user
needs to decide which sub-model will be used for lateral water transfer
processes (a decision similar to choosing the plant transpiration
sub-model in <strong>medfate</strong>), by default “tetis”:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/default_watershed_control.html">default_watershed_control</a></span><span class="op">(</span><span class="st">"tetis"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h2>
<p>Simulation model inputs need to be created for the target watershed
before launching simulations. This may be done automatically, though,
when calling watershed simulation functions, but in many occasions it is
practical to perform this step separately. If we plan to use function
<code><a href="../../reference/spwb_land.html">spwb_land()</a></code>, watershed initialization would be as
follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, SpParams <span class="op">=</span> <span class="va">SpParamsMED</span>,</span>
<span>                                     local_control <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span>soilDomains <span class="op">=</span> <span class="st">"buckets"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating 65 state objects for model 'spwb'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Creating 65 state objects for model 'spwb'. <span style="color: #B2B2B2;">[14ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## • Transpiration mode [Granier: 65, Sperry: 0, Sureau: 0]</span></span></code></pre>
<pre><code><span><span class="co">## • Soil domains [buckets: 65, single: 0, dual: 0]</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_init</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 15</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 9 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;, crop_factor &lt;dbl&gt;</span></span></span></code></pre>
<p>Here we use function <code><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl()</a></code> to specify the
control parameters for local processes. Function
<code><a href="../../reference/initialize_landscape.html">initialize_landscape()</a></code> makes internal calls to
<code><a href="https://emf-creaf.github.io/medfate/reference/modelInput.html" class="external-link">spwbInput()</a></code> of <strong>medfate</strong> and defines a
column <code>state</code> with the initialized inputs.</p>
<p>At this point is important to learn one option that may speed up
calculations. Initialization may be done while simplifying forest
structure to the dominant species (see function
<code><a href="https://emf-creaf.github.io/medfate/reference/forest_simplification.html" class="external-link">forest_reduceToDominant()</a></code> in package
<strong>medfate</strong>). Hence, we can initialize using
<code>reduce_to_dominant = TRUE</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_simplified</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, SpParams <span class="op">=</span> <span class="va">SpParamsMED</span>,</span>
<span>                                           local_control <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span>soilDomains <span class="op">=</span> <span class="st">"single"</span><span class="op">)</span>,</span>
<span>                                           reduce_to_dominant <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating 65 state objects for model 'spwb'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Creating 65 state objects for model 'spwb'. <span style="color: #B2B2B2;">[6ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## • Transpiration mode [Granier: 65, Sperry: 0, Sureau: 0]</span></span></code></pre>
<pre><code><span><span class="co">## • Soil domains [buckets: 0, single: 65, dual: 0]</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_simplified</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 15</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 9 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;, crop_factor &lt;dbl&gt;</span></span></span></code></pre>
<p>For computational reasons, we will keep with this simplified
initialization in the next sections.</p>
</div>
<div class="section level2">
<h2 id="carrying-out-simulations">Carrying out simulations<a class="anchor" aria-label="anchor" href="#carrying-out-simulations"></a>
</h2>
<div class="section level3">
<h3 id="launching-watershed-simulations">Launching watershed simulations<a class="anchor" aria-label="anchor" href="#launching-watershed-simulations"></a>
</h3>
<p>To speed up calculations, we call function <code><a href="../../reference/spwb_land.html">spwb_land()</a></code>
for a single month:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-31"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_simplified</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Although simulations are performed using daily temporal steps,
parameter <code>summary_frequency</code> allows storing cell-level
results at coarser temporal scales, to reduce the amount of memory in
spatial results (see also parameter <code>summary_blocks</code> to
decide which outputs are to be kept in summaries).</p>
</div>
<div class="section level3">
<h3 id="structure-of-simulation-outputs">Structure of simulation outputs<a class="anchor" aria-label="anchor" href="#structure-of-simulation-outputs"></a>
</h3>
<p>Function <code><a href="../../reference/spwb_land.html">spwb_land()</a></code> and <code><a href="../../reference/spwb_land.html">growth_land()</a></code>
return a list with the following elements:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "watershed_control"      "sf"                     "watershed_balance"     </span></span>
<span><span class="co">## [4] "watershed_soil_balance" "channel_export_m3s"     "outlet_export_m3s"</span></span></code></pre>
<p>Where <code>sf</code> is an object of class <code>sf</code>,
analogous to those of functions <code>*_spatial()</code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 10 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 11</span></span></span>
<span><span class="co">##            geometry state            aquifer snowpack summary  result outlet</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   4.95       3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>    0.059<span style="text-decoration: underline;">6</span>     3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   0.299      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   0.713      3.24 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   8.75       3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>  925.         3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> TRUE  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>  525.         3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   0.067<span style="text-decoration: underline;">2</span>     3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370) <span style="color: #949494;">&lt;spwbInpt [19]&gt;</span>   0.394      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>    1.04       3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 4 more variables: channel &lt;lgl&gt;, target_outlet &lt;int&gt;, outlet_backlog &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   subwatershed &lt;int&gt;</span></span></span></code></pre>
<p>Columns <code>state</code>, <code>aquifer</code> and
<code>snowpack</code> contain state variables, whereas
<code>summary</code> contains temporal summaries for all cells. Column
<code>result</code> is empty in this case, but see below.</p>
<p>The next two elements of the simulation result list, namely
<code>watershed_balance</code> and <code>watershed_soil_balance</code>,
refer to watershed-level results. For example,
<code>watershed_balance</code> contains the daily elements of the water
balance at the watershed level, including the amount of water exported
in mm in the last column.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        dates       PET Precipitation      Rain Snow Snowmelt Interception</span></span>
<span><span class="co">## 1 2001-01-01 0.9003872      4.869109  4.869109    0        0     1.524828</span></span>
<span><span class="co">## 2 2001-01-02 1.5958674      2.498292  2.498292    0        0     1.210543</span></span>
<span><span class="co">## 3 2001-01-03 1.3417718      0.000000  0.000000    0        0     0.000000</span></span>
<span><span class="co">## 4 2001-01-04 0.6054039      5.796973  5.796973    0        0     1.515057</span></span>
<span><span class="co">## 5 2001-01-05 1.6387324      1.884401  1.884401    0        0     1.016077</span></span>
<span><span class="co">## 6 2001-01-06 1.2058183     13.359801 13.359801    0        0     1.704274</span></span>
<span><span class="co">##      NetRain Infiltration InfiltrationExcess SaturationExcess  CellRunon</span></span>
<span><span class="co">## 1  3.3442808    3.3442808         0.00000000                0 0.00000000</span></span>
<span><span class="co">## 2  1.2877488    1.2877488         0.00000000                0 0.00000000</span></span>
<span><span class="co">## 3  0.0000000    0.0000000         0.00000000                0 0.00000000</span></span>
<span><span class="co">## 4  4.2819157    4.2819157         0.00000000                0 0.00000000</span></span>
<span><span class="co">## 5  0.8683247    0.8683247         0.00000000                0 0.00000000</span></span>
<span><span class="co">## 6 11.6555266   11.6555266         0.05090607                0 0.05090607</span></span>
<span><span class="co">##   CellRunoff DeepDrainage CapillarityRise DeepAquiferLoss SoilEvaporation</span></span>
<span><span class="co">## 1 0.00000000  0.077285504               0               0      0.26502076</span></span>
<span><span class="co">## 2 0.00000000  0.041094767               0               0      0.16789385</span></span>
<span><span class="co">## 3 0.00000000  0.002816163               0               0      0.18274377</span></span>
<span><span class="co">## 4 0.00000000  0.091668854               0               0      0.09931928</span></span>
<span><span class="co">## 5 0.00000000  0.031688356               0               0      0.14827048</span></span>
<span><span class="co">## 6 0.05090607  0.157048292               0               0      0.11148804</span></span>
<span><span class="co">##   Transpiration HerbTranspiration InterflowBalance BaseflowBalance</span></span>
<span><span class="co">## 1     0.4309517                 0     0.000000e+00   -5.174601e-18</span></span>
<span><span class="co">## 2     0.7632100                 0    -5.046468e-17    3.195111e-18</span></span>
<span><span class="co">## 3     0.6410802                 0     8.915427e-17    7.454711e-18</span></span>
<span><span class="co">## 4     0.2894745                 0     1.286849e-16    9.317568e-18</span></span>
<span><span class="co">## 5     0.7836103                 0     1.648513e-16    7.030887e-18</span></span>
<span><span class="co">## 6     0.5764833                 0    -1.366752e-17   -5.986110e-18</span></span>
<span><span class="co">##   AquiferExfiltration ChannelExport WatershedExport NegativeAquiferCorrection</span></span>
<span><span class="co">## 1                   0             0               0                         0</span></span>
<span><span class="co">## 2                   0             0               0                         0</span></span>
<span><span class="co">## 3                   0             0               0                         0</span></span>
<span><span class="co">## 4                   0             0               0                         0</span></span>
<span><span class="co">## 5                   0             0               0                         0</span></span>
<span><span class="co">## 6                   0             0               0                         0</span></span></code></pre>
<p>Values of this output data frame are averages across cells in the
landscape. Data frame <code>watershed_soil_balance</code> is similar to
<code>watershed_balance</code> but focusing on cells that have a soil
(i.e. excluding artificial, rock or water land cover). Finally,
<code>channel_export_m3s</code> contains the average river flow reaching
each channel cell each day and <code>outlet_export_m3s</code> contains
the average river flow reaching each outlet cell each day (both in units
of cubic meters per second):</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">outlet_export_m3s</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            6</span></span>
<span><span class="co">## 2001-01-01 0</span></span>
<span><span class="co">## 2001-01-02 0</span></span>
<span><span class="co">## 2001-01-03 0</span></span>
<span><span class="co">## 2001-01-04 0</span></span>
<span><span class="co">## 2001-01-05 0</span></span>
<span><span class="co">## 2001-01-06 0</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="watershed-level-summaries-and-plots">Watershed-level summaries and plots<a class="anchor" aria-label="anchor" href="#watershed-level-summaries-and-plots"></a>
</h3>
<p>The components of watershed-level water balance can be displayed in
the console using a tailored <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Snowpack water balance components:</span></span>
<span><span class="co">##     Snow fall (mm) 16.65  Snow melt (mm) 13.1</span></span>
<span><span class="co">##   Soil water balance components:</span></span>
<span><span class="co">##     Infiltration (mm) 54.71  Saturation excess (mm) 0</span></span>
<span><span class="co">##     Deep drainage (mm) 39.33  Capillarity rise (mm) 0</span></span>
<span><span class="co">##     Soil evaporation (mm) 1.59  Plant transpiration (mm) 15.23</span></span>
<span><span class="co">##     Interflow balance (mm) 0</span></span>
<span><span class="co">##   Aquifer water balance components:</span></span>
<span><span class="co">##     Deep drainage (mm) 39.76  Capillarity rise (mm) 0</span></span>
<span><span class="co">##     Exfiltration (mm) 16.8  Deep aquifer loss (mm) 0</span></span>
<span><span class="co">##     Negative aquifer correction (mm) 0</span></span>
<span><span class="co">##   Watershed water balance components:</span></span>
<span><span class="co">##     Precipitation (mm) 74.75</span></span>
<span><span class="co">##     Interception (mm) 16.29  Soil evaporation (mm) 1.56</span></span>
<span><span class="co">##     Plant transpiration (mm) 15</span></span>
<span><span class="co">##     Subsurface flow balance (mm) 0</span></span>
<span><span class="co">##     Groundwater flow balance (mm) 0</span></span>
<span><span class="co">##     Export runoff (mm) 16.8</span></span></code></pre>
<p>Analogously to plots available with package <strong>medfate</strong>,
one can display time series of watershed-level water balance components
using function <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, for example:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res_ws1</span>, type <span class="op">=</span> <span class="st">"Export"</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;"></p>
<p>or the usual combination of hietograph and hydrograph using:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res_ws1</span>, type <span class="op">=</span> <span class="st">"Hydrograph"</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="accessing-and-plotting-cell-summaries">Accessing and plotting cell summaries<a class="anchor" aria-label="anchor" href="#accessing-and-plotting-cell-summaries"></a>
</h3>
<p>Unlike <code><a href="../../reference/spwb_spatial.html">spwb_spatial()</a></code> where summaries could be
arbitrarily generated <em>a posteriori</em> from simulation results,
with <code><a href="../../reference/spwb_land.html">spwb_land()</a></code> the summaries are always fixed and
embedded with the simulation result. For example, we can inspect the
summaries for a given landscape cell using:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">summary</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##            MinTemperature MaxTemperature      PET     Rain     Snow      SWE</span></span>
<span><span class="co">## 2001-01-01      -3.203556       2.427977 31.14151 58.09884 16.65065 1.949332</span></span>
<span><span class="co">##                 RWC SoilVol      WTD      DTA</span></span>
<span><span class="co">## 2001-01-01 105.9293 570.065 3432.313 15.47638</span></span></code></pre>
<p>Additional variables (water balance components, carbon balance
components, etc.) can be added to summaries via parameter
<code>summary_blocks</code>. Some of these summaries are temporal
averages (e.g. state variables), while others are temporal sums
(e.g. water or carbon balance components), depending on the
variable.</p>
<p>Maps of variable summaries can be drawn from the result of function
<code><a href="../../reference/spwb_land.html">spwb_land()</a></code> in a similar way as done for
<code><a href="../../reference/spwb_spatial.html">spwb_spatial()</a></code>. As an example we display a map of the
average soil relative water content during the simulated month:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"RWC"</span>, date <span class="op">=</span> <span class="st">"2001-01-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="full-simulation-results-for-specific-cells">Full simulation results for specific cells<a class="anchor" aria-label="anchor" href="#full-simulation-results-for-specific-cells"></a>
</h3>
<p>The idea of generating summaries arises from the fact that local
models can produce a large amount of results, of which only some are of
interest at the landscape level. Nevertheless, it is possible to specify
those cells for which full daily results are desired. This is done by
adding a column <code>result_cell</code> in the input <code>sf</code>
object:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set request for daily model results in cells number 3 and 9</span></span>
<span><span class="va">example_simplified</span><span class="op">$</span><span class="va">result_cell</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">example_simplified</span><span class="op">$</span><span class="va">result_cell</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">9</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<p>If we launch the simulations again (omitting progress
information):</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_simplified</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can now retrieve the results of the desired cell, e.g. the third
one, in column <code>result</code> of <code>sf</code>:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S</span> <span class="op">&lt;-</span> <span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "spwb" "list"</span></span></code></pre>
<p>This object has class <code>spwb</code> and the same structure
returned by function <code><a href="https://emf-creaf.github.io/medfate/reference/spwb.html" class="external-link">spwb()</a></code> of <strong>medfate</strong>.
Hence, we can inspect daily results using functions
<code><a href="https://emf-creaf.github.io/medfate/reference/shinyplot.html" class="external-link">shinyplot()</a></code> or <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, for example:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">S</span>, <span class="st">"SoilRWC"</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="continuing-a-previous-simulation">Continuing a previous simulation<a class="anchor" aria-label="anchor" href="#continuing-a-previous-simulation"></a>
</h3>
<p>The result of a simulation includes an element <code>state</code>,
which stores the state of soil and stand variables at the end of the
simulation. This information can be used to perform a new simulation
from the point where the first one ended. In order to do so, we need to
update the state variables in spatial object with their values at the
end of the simulation, using function
<code><a href="../../reference/update_landscape.html">update_landscape()</a></code>:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_watershed_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/update_landscape.html">update_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, <span class="va">res_ws1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">example_watershed_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "geometry"             "id"                   "elevation"           </span></span>
<span><span class="co">##  [4] "slope"                "aspect"               "land_cover_type"     </span></span>
<span><span class="co">##  [7] "forest"               "soil"                 "state"               </span></span>
<span><span class="co">## [10] "depth_to_bedrock"     "bedrock_conductivity" "bedrock_porosity"    </span></span>
<span><span class="co">## [13] "snowpack"             "aquifer"              "crop_factor"         </span></span>
<span><span class="co">## [16] "outlet_backlog"</span></span></code></pre>
<p>Note that a new column <code>state</code> appears in now in the
<strong>sf</strong> object. We can check the effect by drawing the
relative water content:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed_mod</span>, variable <span class="op">=</span> <span class="st">"soil_rwc_curr"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-24-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now we can continue our simulation, in this case adding an extra
month:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-02-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-02-28"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_mod</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The fact that no cell required initialization is an indication that
we used an already initialized landscape.</p>
</div>
<div class="section level3">
<h3 id="burn-in-periods">Burn-in periods<a class="anchor" aria-label="anchor" href="#burn-in-periods"></a>
</h3>
<p>Like other distributed hydrological models, watershed simulations
with <strong>medfateland</strong> will normally require a burn-in period
to allow soil moisture and aquifer levels to reach a dynamic
equilibrium. We recommend users to use at least one or two years of
burn-in period, but this will depend on the size of the watershed. In
<strong>medfate</strong> we provide users with a copy of the example
watershed, where burn-in period has already been simulated. This can be
seen by inspecting the aquifer level:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_watershed_burnin"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed_burnin</span>, variable <span class="op">=</span> <span class="st">"aquifer"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-26-1.png" width="672" style="display: block; margin: auto;"></p>
<p>If we run a one-month simulation on this data set we can then compare
the output before and after the burn-in period to illustrate its
importance:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-31"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"before"</span> <span class="op">=</span> <span class="va">res_ws1</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">$</span><span class="va">WatershedExport</span>, </span>
<span>           <span class="st">"after"</span> <span class="op">=</span> <span class="va">res_ws3</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">$</span><span class="va">WatershedExport</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       before      after</span></span>
<span><span class="co">## 1  0.0000000 0.12816556</span></span>
<span><span class="co">## 2  0.0000000 0.09986587</span></span>
<span><span class="co">## 3  0.0000000 0.07090369</span></span>
<span><span class="co">## 4  0.0000000 0.17218497</span></span>
<span><span class="co">## 5  0.0000000 0.12998927</span></span>
<span><span class="co">## 6  0.0000000 0.33157200</span></span>
<span><span class="co">## 7  0.0000000 0.21527091</span></span>
<span><span class="co">## 8  0.0000000 0.24910774</span></span>
<span><span class="co">## 9  0.0000000 0.24349869</span></span>
<span><span class="co">## 10 0.0000000 0.40573446</span></span>
<span><span class="co">## 11 0.0000000 0.40353996</span></span>
<span><span class="co">## 12 0.0000000 0.52421850</span></span>
<span><span class="co">## 13 0.0000000 0.52801014</span></span>
<span><span class="co">## 14 0.0000000 0.60477634</span></span>
<span><span class="co">## 15 0.0000000 0.62605392</span></span>
<span><span class="co">## 16 0.0000000 0.63996737</span></span>
<span><span class="co">## 17 0.0000000 0.63444712</span></span>
<span><span class="co">## 18 0.0000000 0.62184369</span></span>
<span><span class="co">## 19 0.3766724 0.60503029</span></span>
<span><span class="co">## 20 0.7494492 0.58443928</span></span>
<span><span class="co">## 21 0.9717337 0.69000921</span></span>
<span><span class="co">## 22 1.1772553 0.71876789</span></span>
<span><span class="co">## 23 1.2670371 0.70530849</span></span>
<span><span class="co">## 24 1.3620809 0.75554198</span></span>
<span><span class="co">## 25 1.4573525 0.76373163</span></span>
<span><span class="co">## 26 1.5647762 0.74564720</span></span>
<span><span class="co">## 27 1.6437539 0.72447288</span></span>
<span><span class="co">## 28 1.6449920 0.71724418</span></span>
<span><span class="co">## 29 1.5856965 0.68262892</span></span>
<span><span class="co">## 30 1.5163174 0.64161090</span></span>
<span><span class="co">## 31 1.4789010 0.61954667</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulations-of-watershed-forest-dynamics">Simulations of watershed forest dynamics<a class="anchor" aria-label="anchor" href="#simulations-of-watershed-forest-dynamics"></a>
</h3>
<p>Running <code><a href="../../reference/spwb_land.html">growth_land()</a></code> is very similar to running
<code><a href="../../reference/spwb_land.html">spwb_land()</a></code>. However, a few things change when we want to
simulate forest dynamics using <code><a href="../../reference/spwb_land.html">fordyn_land()</a></code>. Regarding the
<code>sf</code> input, an additional column
<code>management_arguments</code> may be defined to specify the forest
management arguments (i.e. silviculture) of cells. Furthermore, the
function does not allow choosing the temporal scale of summaries. Strong
simplification of forest structure to dominant species will not normally
make sense in this kind of simulation, since the focus is on forest
dynamics.</p>
<p>A call to <code><a href="../../reference/spwb_land.html">fordyn_land()</a></code> for a single year is given here,
as an example, starting from the initial example watershed:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">fordyn_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed</span>,</span>
<span>                       <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>,</span>
<span>                       watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulations-using-weather-interpolation">Simulations using weather interpolation<a class="anchor" aria-label="anchor" href="#simulations-using-weather-interpolation"></a>
</h3>
<p>Large watersheds will have spatial differences in climatic conditions
like temperature, precipitation. Specifying a single weather data frame
for all the watershed may be not suitable in this case. Specifying a
different weather data frame for each watershed cell can also be a
problem, if spatial resolution is high, due to the huge data
requirements. A solution for this can be using interpolation on the fly,
inside watershed simulations. This can be done by supplying an
<strong>interpolator</strong> object (or a list of them), as defined in
package <strong>meteoland</strong>. Here we use the example data
provided in the package:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interpolator</span> <span class="op">&lt;-</span> <span class="fu">meteoland</span><span class="fu">::</span><span class="fu"><a href="https://emf-creaf.github.io/meteoland/reference/with_meteo.html" class="external-link">with_meteo</a></span><span class="op">(</span><span class="va">meteoland_meteo_example</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">meteoland</span><span class="fu">::</span><span class="fu"><a href="https://emf-creaf.github.io/meteoland/reference/create_meteo_interpolator.html" class="external-link">create_meteo_interpolator</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu">defaultInterpolationParams</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating interpolator...</span></span></code></pre>
<pre><code><span><span class="co">##   • Calculating smoothed variables...</span></span></code></pre>
<pre><code><span><span class="co">##   • Updating intial_Rp parameter with the actual stations mean distance...</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Interpolator created.</span></span></code></pre>
<p>Once we have this object, using it is straightforward:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>, <span class="va">SpParamsMED</span>, </span>
<span>                     meteo <span class="op">=</span> <span class="va">interpolator</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                     watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Note that we did not define dates, which are taken from the
interpolator data. If we plot the minimum temperature, we will
appreciate the spatial variation in climate:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws5</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"MinTemperature"</span>, date <span class="op">=</span> <span class="st">"2022-04-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-31-1.png" width="672" style="display: block; margin: auto;"></p>
<p>For large watersheds and fine spatial resolution interpolation can
become slow. One can then specify that interpolation is performed on a
coarser grid, by using a watershed control parameter, for example:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws_control</span><span class="op">$</span><span class="va">weather_aggregation_factor</span> <span class="op">&lt;-</span> <span class="fl">3</span></span></code></pre></div>
<p>To illustrate its effect, we repeat the previous simulation and plot
the minimum temperature:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>, <span class="va">SpParamsMED</span>, </span>
<span>                     meteo <span class="op">=</span> <span class="va">interpolator</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                     watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws6</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"MinTemperature"</span>, date <span class="op">=</span> <span class="st">"2022-04-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="parallel-simulations-using-subwatersheds">Parallel simulations using subwatersheds<a class="anchor" aria-label="anchor" href="#parallel-simulations-using-subwatersheds"></a>
</h2>
<p>Simulations can be rather slow even for moderately-sized watersheds.
For these reason, <strong>medfateland</strong> now incorporates the
possibility to perform parallel simulations in subwatersheds, and then
aggregate the results. To illustrate this feature we will use the data
set of Bianya watershed (see <a href="https://emf-creaf.github.io/medfateland/articles/intro/PreparingInputs_II.html%5D">Preparing
inputs II: arbitrary locations</a>; you can find the dataset in the
<strong>medfateland</strong> GitHub repository).</p>
<p>We begin by loading the raster and <code>sf</code> inputs for
Bianya:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"../intro/bianya_raster.tif"</span><span class="op">)</span></span>
<span><span class="va">sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../intro/bianya.rds"</span><span class="op">)</span></span></code></pre></div>
<p>If we draw the elevation map, we will visually identify two
subwatersheds:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"elevation"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-35-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Package <strong>medfateland</strong> includes function
<code><a href="../../reference/overland_routing.html">overland_routing()</a></code> to statically illustrate how overland
runoff processes are dealt with (i.e. distribution of runoff among
neighbors, channel routing, etc.).</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">or</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/overland_routing.html">overland_routing</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">or</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 6 features and 12 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 449799.3 ymin: 4678387 xmax: 450794.5 ymax: 4678387</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 13</span></span></span>
<span><span class="co">##             geometry elevation slope waterRank waterOrder queenNeigh</span></span>
<span><span class="co">##          <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> (449799.3 4678387)      900.  24.5       401       <span style="text-decoration: underline;">2</span>533 <span style="color: #949494;">&lt;int [4]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> (449998.3 4678387)      901.  27.5       399       <span style="text-decoration: underline;">2</span>455 <span style="color: #949494;">&lt;int [5]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> (450197.4 4678387)      880.  23.2       446       <span style="text-decoration: underline;">2</span>416 <span style="color: #949494;">&lt;int [5]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> (450396.4 4678387)      843.  27.9       554       <span style="text-decoration: underline;">2</span>487 <span style="color: #949494;">&lt;int [5]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> (450595.5 4678387)      878.  16.9       454       <span style="text-decoration: underline;">2</span>534 <span style="color: #949494;">&lt;int [5]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> (450794.5 4678387)      860.  22.4       508       <span style="text-decoration: underline;">2</span>511 <span style="color: #949494;">&lt;int [4]&gt;</span> </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 7 more variables: waterQ &lt;list&gt;, channel &lt;lgl&gt;, outlet &lt;lgl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   target_outlet &lt;int&gt;, distance_to_outlet &lt;dbl&gt;, outlet_backlog &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   subwatershed &lt;int&gt;</span></span></span></code></pre>
<p>In this function we can specifically ask for sub-watersheds, as
follows:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">or</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/overland_routing.html">overland_routing</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">sf</span>, subwatersheds <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       max_overlap <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p>In short, sub-watershed definition consists in: (a) finding the
drainage basin of each outlet or channel cell; (b) aggregating drainage
basins until the overlap is less than the specified parameter; and (c)
deciding to which sub-watershed each border cell belongs to. This
function identified three sub-watersheds, one of them being an isolated
channel cell:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or</span><span class="op">[</span>, <span class="st">"subwatershed"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-38-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Let’s now illustrate how to perform watershed simulations with
parallelization and subwatersheds. We begin by initializing the input
(here we used a <code>"buckets"</code> soil hydrology to speed up
calculations, but <code>"single"</code> would be more appropriate).</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sf_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">sf</span>, SpParams <span class="op">=</span> <span class="va">SpParamsMED</span>,</span>
<span>                                local_control <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span>soilDomains <span class="op">=</span> <span class="st">"buckets"</span><span class="op">)</span>,</span>
<span>                                progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Subwatershed definition is controlled via watershed control options
as follows (simulation functions internally call
<code><a href="../../reference/overland_routing.html">overland_routing()</a></code>):</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/default_watershed_control.html">default_watershed_control</a></span><span class="op">(</span><span class="st">"tetis"</span><span class="op">)</span></span>
<span><span class="va">ws_control</span><span class="op">$</span><span class="va">tetis_parameters</span><span class="op">$</span><span class="va">subwatersheds</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">ws_control</span><span class="op">$</span><span class="va">tetis_parameters</span><span class="op">$</span><span class="va">max_overlap</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span></code></pre></div>
<p>Now, we are ready to launch the watershed simulation with
parallelization. This consists in performing simulations for each
subwatershed independently, aggregating the results and, finally,
performing channel routing.</p>
<p>For simplicity, we only simulate five days. We ask for console output
to see what the model is doing:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-04-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-04-05"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">sf_init</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">interpolator</span>, dates <span class="op">=</span> <span class="va">dates</span>,</span>
<span>                    summary_frequency <span class="op">=</span> <span class="st">"day"</span>, summary_blocks <span class="op">=</span> <span class="st">"WaterBalance"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    parallelize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Simulation of model 'spwb' over a watershed</span> <span style="color: #00BBBB;">─────────────────────────────────</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">INPUT CHECKING</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking raster topology</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Checking raster topology <span style="color: #B2B2B2;">[15ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking 'sf' data columns</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Column 'snowpack' was missing in 'sf'. Initializing empty snowpack.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking 'sf' data columns<span style="color: #00BBBB;">ℹ</span> Minimum bedrock porosity set to 0.1%.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking 'sf' data columns<span style="color: #00BBBB;">ℹ</span> Column 'aquifer' was missing in 'sf'. Initializing empty aquifer.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Checking 'sf' data columns<span style="color: #00BB00;">✔</span> Checking 'sf' data columns <span style="color: #B2B2B2;">[3.9s]</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Determining neighbors and overland routing for TETIS</span></span>
<span><span class="co">## <span style="color: #00BB00;">✔</span> Determining neighbors and overland routing for TETIS <span style="color: #B2B2B2;">[2.2s]</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## • Hydrological model: TETIS</span></span>
<span><span class="co">## • Number of grid cells: 3825 Number of target cells: 2573</span></span>
<span><span class="co">## • Average cell area: 39575 m2, Total area: 15138 ha, Target area: 10183 ha</span></span>
<span><span class="co">## • Cell land use [wildland: 2161 agriculture: 331 artificial: 78 rock: 0 water:</span></span>
<span><span class="co">## 3]</span></span>
<span><span class="co">## • Cells with soil: 2492</span></span>
<span><span class="co">## • Number of days to simulate: 5</span></span>
<span><span class="co">## • Number of temporal cell summaries: 5</span></span>
<span><span class="co">## • Number of cells with daily model results requested: 0</span></span>
<span><span class="co">## • Number of channel cells: 158</span></span>
<span><span class="co">## • Number of outlet cells: 28</span></span>
<span><span class="co">## • Number of subwatersheds: 3</span></span>
<span><span class="co">## • Weather interpolation factor: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">INITIALISATION</span> ──</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> All state objects are already available for 'spwb'.</span></span>
<span><span class="co">## • Transpiration mode [Granier: 2492, Sperry: 0, Sureau: 0]</span></span>
<span><span class="co">## • Soil domains [buckets: 2492, single: 0, dual: 0]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">PARALLEL SIMULATION of 3 SUB-WATERSHEDS in 3 NODES</span> ──</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">MERGING SUB-WATERSHED RESULTS</span> ──</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">CHANNEL ROUTING</span> ──</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## • Initial outlet backlog sum (m3): 0</span></span>
<span><span class="co">## • Channel balance target (m3): 0 outlet change (m3): 0 backlog change (m3): 0</span></span>
<span><span class="co">## • Final outlet backlog sum (m3): 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── <span style="font-weight: bold;">FINAL BALANCE CHECK</span> ──</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## • Final channel sum (m3): 0</span></span>
<span><span class="co">## • Final outlet sum (m3): 0</span></span>
<span><span class="co">## • Final watershed export sum (m3): 0</span></span></code></pre>
<p>As an example of the output, we show a map of woody plant
transpiration (note that we asked for water balance components using
<code>summary_blocks = "WaterBalance"</code>:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws7</span>, variable <span class="op">=</span> <span class="st">"Transpiration"</span>, date <span class="op">=</span> <span class="st">"2022-04-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-42-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miquel De Cáceres, Aitor Améztegui, María González, Núria Aquilué, Daniel Caviedes-Voullième, Mario Morales-Hernández.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
