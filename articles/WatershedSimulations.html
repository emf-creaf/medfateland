<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watershed simulations • medfateland</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Watershed simulations">
<meta property="og:description" content="medfateland">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">medfateland</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Watershed simulations</h1>
                        <h4 data-toc-skip class="author">Miquel De
Caceres</h4>
            
            <h4 data-toc-skip class="date">2024-05-24</h4>
      
      
      <div class="hidden name"><code>WatershedSimulations.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="aim">Aim<a class="anchor" aria-label="anchor" href="#aim"></a>
</h2>
<p>The aim of this vignette is to illustrate how to use
<strong>medfateland</strong> (v. 2.4.1) to carry out simulations of
forest function and dynamics on a set of forest stands while including
lateral water transfer processes. This is done using functions
<code><a href="../reference/spwb_land.html">spwb_land()</a></code>, <code><a href="../reference/spwb_land.html">growth_land()</a></code> and
<code><a href="../reference/spwb_land.html">fordyn_land()</a></code>; which are counterparts of functions
<code><a href="https://emf-creaf.github.io/medfate/reference/spwb.html" class="external-link">spwb()</a></code>, <code><a href="https://emf-creaf.github.io/medfate/reference/growth.html" class="external-link">growth()</a></code> and <code><a href="https://emf-creaf.github.io/medfate/reference/fordyn.html" class="external-link">fordyn()</a></code> in
package <strong>medfate</strong>. We will focus here on function
<code><a href="../reference/spwb_land.html">spwb_land()</a></code>, but the other two functions would be used
similarly. The same can be said for functions
<code><a href="../reference/spwb_land_day.html">spwb_land_day()</a></code> and <code><a href="../reference/spwb_land_day.html">growth_land_day()</a></code>, which
are counterparts of <code><a href="https://emf-creaf.github.io/medfate/reference/spwb_day.html" class="external-link">spwb_day()</a></code> and
<code><a href="https://emf-creaf.github.io/medfate/reference/spwb_day.html" class="external-link">growth_day()</a></code>, respectively.</p>
</div>
<div class="section level2">
<h2 id="preparation">Preparation<a class="anchor" aria-label="anchor" href="#preparation"></a>
</h2>
<p>Preparing inputs for watershed simulations can be tedious. Two main
inputs need to be assembled, described in the following two
sections.</p>
<div class="section level3">
<h3 id="input-sf-objects">Input sf objects<a class="anchor" aria-label="anchor" href="#input-sf-objects"></a>
</h3>
<p>Here we load a small example watershed included with the package,
that can be used to understand the inputs required:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_watershed"</span><span class="op">)</span></span>
<span><span class="va">example_watershed</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 13 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 14</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 8 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;</span></span></span></code></pre>
<p>Some of the columns like <code>forest</code>, <code>soil</code>,
<code>elevation</code>, or <code>state</code>, were also present in the
example for spatially-uncoupled simulations, so we will not repeat them.
The following describes additional columns that are relevant here.</p>
<p><strong>Land cover type</strong></p>
<p>Simulations over watersheds normally include different land cover
types. These are described in column <code>land_cover_type</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">example_watershed</span><span class="op">$</span><span class="va">land_cover_type</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## agriculture        rock    wildland </span></span>
<span><span class="co">##          17           1          48</span></span></code></pre>
<p>Local and landscape processes will behave differently depending on
the land cover type.</p>
<p><strong>Aquifer and snowpack</strong></p>
<p>Columns <code>aquifer</code> and <code>snowpack</code> are used as
state variables to store the water content in the aquifer and snowpack,
respectively.</p>
<p><strong>Crop factors</strong></p>
<p>Since the landscape contains agricultural lands, we need to define
<em>crop factors</em>, which will determine transpiration flow as a
proportion of potential evapotranspiration:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_watershed</span><span class="op">$</span><span class="va">crop_factor</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">example_watershed</span><span class="op">$</span><span class="va">crop_factor</span><span class="op">[</span><span class="va">example_watershed</span><span class="op">$</span><span class="va">land_cover_type</span><span class="op">==</span><span class="st">"agriculture"</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.75</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="grid-topology">Grid topology<a class="anchor" aria-label="anchor" href="#grid-topology"></a>
</h3>
<p>Note that the <code>sf</code> structure does not imply a grid <em>per
se</em>. Point geometry is used to describe the central coordinates of
grid cells, but does not describe the grid. This means that another
spatial input is needed to describe the grid topology, which in our case
is an object of class <code>SpatRaster</code> from package
<strong>terra</strong>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">401380</span>, ymin <span class="op">=</span> <span class="fl">4671820</span>, xmax <span class="op">=</span> <span class="fl">402880</span>, ymax <span class="op">=</span> <span class="fl">4672620</span>, </span>
<span>                nrow <span class="op">=</span> <span class="fl">8</span>, ncol <span class="op">=</span> <span class="fl">15</span>, crs <span class="op">=</span> <span class="st">"epsg:32631"</span><span class="op">)</span></span>
<span><span class="va">r</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 8, 15, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 100, 100  (x, y)</span></span>
<span><span class="co">## extent      : 401380, 402880, 4671820, 4672620  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : WGS 84 / UTM zone 31N (EPSG:32631)</span></span></code></pre>
<p>The <code>r</code> object must have the same coordinate reference
system as the <code>sf</code> object. Moreover, each grid cell can
contain up to one point of the <code>sf</code> (typically at the cell
center). Some grid cells may be empty, though, so that the actual
simulations may be done on an incomplete grid. Note that the raster does
not contain data, only the topology is needed (to define neighbors and
cell sizes, for example). All relevant attribute data is already
included in the <code>sf</code> object.</p>
<p>Combining the <code>r</code> and <code>sf</code> objects allows
drawing rasterized maps:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed</span>, variable <span class="op">=</span> <span class="st">"elevation"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="watershed-control-options">Watershed control options<a class="anchor" aria-label="anchor" href="#watershed-control-options"></a>
</h3>
<p>Analogously to local-scale simulations with <strong>medfate</strong>,
watershed simulations have overall control parameters. Notably, the user
needs to decide which sub-model will be used for lateral water transfer
processes (a decision similar to choosing the plant transpiration
sub-model in <strong>medfate</strong>), by default “tetis”:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/default_watershed_control.html">default_watershed_control</a></span><span class="op">(</span><span class="st">"tetis"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h2>
<p>Simulation model inputs need to be created for the target watershed
before launching simulations. This may be done automatically, though,
when calling watershed simulation functions, but in many occasions it is
practical to perform this step separately. If we plan to use function
<code><a href="../reference/spwb_land.html">spwb_land()</a></code>, watershed initialization would be as
follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, SpParams <span class="op">=</span> <span class="va">SpParamsMED</span>,</span>
<span>                                     local_control <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating 65 state objects for model 'spwb'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Creating 65 state objects for model 'spwb'. <span style="color: #B2B2B2;">[18ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_init</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 15</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 9 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;, crop_factor &lt;dbl&gt;</span></span></span></code></pre>
<p>Here we use function <code><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl()</a></code> to specify the
control parameters for local processes. Function
<code><a href="../reference/initialize_landscape.html">initialize_landscape()</a></code> makes internal calls to
<code><a href="https://emf-creaf.github.io/medfate/reference/modelInput.html" class="external-link">spwbInput()</a></code> of <strong>medfate</strong> and defines a
column <code>state</code> with the initialized inputs.</p>
<p>At this point is important to learn one option that may speed up
calculations. Initialization may be done while simplifying forest
structure to the dominant species (see function
<code><a href="https://emf-creaf.github.io/medfate/reference/forest_simplification.html" class="external-link">forest_reduceToDominant()</a></code> in package
<strong>medfate</strong>). Hence, we can initialize using
<code>simplify = TRUE</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_simplified</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, SpParams <span class="op">=</span> <span class="va">SpParamsMED</span>,</span>
<span>                                           local_control <span class="op">=</span> <span class="fu"><a href="https://emf-creaf.github.io/medfate/reference/defaultControl.html" class="external-link">defaultControl</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                           simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating 65 state objects for model 'spwb'.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Creating 65 state objects for model 'spwb'. <span style="color: #B2B2B2;">[6ms]</span></span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_simplified</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 15</span></span></span>
<span><span class="co">##            geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>      <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570)     1      <span style="text-decoration: underline;">1</span>162 11.3   79.2  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470)     2      <span style="text-decoration: underline;">1</span>214 12.4   98.7  agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470)     3      <span style="text-decoration: underline;">1</span>197 10.4  102.   wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470)     4      <span style="text-decoration: underline;">1</span>180  8.12  83.3  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470)     5      <span style="text-decoration: underline;">1</span>164 13.9   96.8  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470)     6      <span style="text-decoration: underline;">1</span>146 11.2    8.47 agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470)     7      <span style="text-decoration: underline;">1</span>153  9.26 356.   agriculture    </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370)     8      <span style="text-decoration: underline;">1</span>237 14.5   75.1  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370)     9      <span style="text-decoration: underline;">1</span>213 13.2   78.7  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370)    10      <span style="text-decoration: underline;">1</span>198  8.56  75.6  agriculture    </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 9 more variables: forest &lt;list&gt;, soil &lt;list&gt;, state &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   depth_to_bedrock &lt;dbl&gt;, bedrock_conductivity &lt;dbl&gt;, bedrock_porosity &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   snowpack &lt;dbl&gt;, aquifer &lt;dbl&gt;, crop_factor &lt;dbl&gt;</span></span></span></code></pre>
<p>For computational reasons, we will keep with this simplified
initialization in the next sections.</p>
</div>
<div class="section level2">
<h2 id="carrying-out-simulations">Carrying out simulations<a class="anchor" aria-label="anchor" href="#carrying-out-simulations"></a>
</h2>
<div class="section level3">
<h3 id="launching-watershed-simulations">Launching watershed simulations<a class="anchor" aria-label="anchor" href="#launching-watershed-simulations"></a>
</h3>
<p>To speed up calculations, we call function <code><a href="../reference/spwb_land.html">spwb_land()</a></code>
for a single month:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-31"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_simplified</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Although simulations are performed using daily temporal steps,
parameter <code>summary_frequency</code> allows storing results at
coarser temporal scales, to reduce the amount of memory in spatial
results.</p>
</div>
<div class="section level3">
<h3 id="structure-of-simulation-outputs">Structure of simulation outputs<a class="anchor" aria-label="anchor" href="#structure-of-simulation-outputs"></a>
</h3>
<p>Function <code><a href="../reference/spwb_land.html">spwb_land()</a></code> and <code><a href="../reference/spwb_land.html">growth_land()</a></code>
return a list with the following elements:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "watershed_control"      "sf"                     "watershed_balance"     </span></span>
<span><span class="co">## [4] "watershed_soil_balance" "outlet_export_m3s"</span></span></code></pre>
<p>Where <code>sf</code> is an object of class <code>sf</code>,
analogous to those of functions <code>*_spatial()</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 66 features and 6 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 401430 ymin: 4671870 xmax: 402830 ymax: 4672570</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 66 × 7</span></span></span>
<span><span class="co">##            geometry state           aquifer snowpack summary  result outlet</span></span>
<span><span class="co">##         <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (402630 4672570) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.090<span style="text-decoration: underline;">8</span>     3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (402330 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>   0.127      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (402430 4672470) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.159      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (402530 4672470) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.192      2.54 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (402630 4672470) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.259      2.57 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (402730 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>   1.33       3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> TRUE  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (402830 4672470) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>   0.211      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (402230 4672370) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.145      2.53 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (402330 4672370) <span style="color: #949494;">&lt;spwbInpt [18]&gt;</span>  0.462      2.81 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (402430 4672370) <span style="color: #949494;">&lt;aspwbInp [4]&gt;</span>   0.661      3.56 <span style="color: #949494;">&lt;dbl[…]&gt;</span> <span style="color: #949494;">&lt;NULL&gt;</span> FALSE </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 56 more rows</span></span></span></code></pre>
<p>Columns <code>state</code>, <code>aquifer</code> and
<code>snowpack</code> contain state variables, whereas
<code>summary</code> contains temporal water balance summaries for all
cells. Column <code>result</code> is empty in this case, but see
below.</p>
<p>The next two elements of the simulation result list, namely
<code>watershed_balance</code> and <code>watershed_soil_balance</code>,
refer to watershed-level results. For example,
<code>watershed_balance</code> contains the daily elements of the water
balance at the watershed level, including the amount of water exported
in mm in the last column.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        dates Precipitation      Rain Snow Snowmelt Interception   NetRain</span></span>
<span><span class="co">## 1 2001-01-01      4.869109  4.869109    0        0    0.7754218  4.093687</span></span>
<span><span class="co">## 2 2001-01-02      2.498292  2.498292    0        0    0.6090627  1.889229</span></span>
<span><span class="co">## 3 2001-01-03      0.000000  0.000000    0        0    0.0000000  0.000000</span></span>
<span><span class="co">## 4 2001-01-04      5.796973  5.796973    0        0    0.7723790  5.024594</span></span>
<span><span class="co">## 5 2001-01-05      1.884401  1.884401    0        0    0.4808826  1.403519</span></span>
<span><span class="co">## 6 2001-01-06     13.359801 13.359801    0        0    0.8613997 12.498401</span></span>
<span><span class="co">##   Infiltration InfiltrationExcess SaturationExcess  CellRunon CellRunoff</span></span>
<span><span class="co">## 1     4.093687         0.00000000                0 0.00000000 0.00000000</span></span>
<span><span class="co">## 2     1.889229         0.00000000                0 0.00000000 0.00000000</span></span>
<span><span class="co">## 3     0.000000         0.00000000                0 0.00000000 0.00000000</span></span>
<span><span class="co">## 4     5.024594         0.00000000                0 0.00000000 0.00000000</span></span>
<span><span class="co">## 5     1.403519         0.00000000                0 0.00000000 0.00000000</span></span>
<span><span class="co">## 6    12.498401         0.05090607                0 0.05090607 0.05090607</span></span>
<span><span class="co">##   DeepDrainage CapillarityRise DeepAquiferLoss SoilEvaporation Transpiration</span></span>
<span><span class="co">## 1  0.077320244    2.548924e-05               0       0.3874890     0.2674045</span></span>
<span><span class="co">## 2  0.041356726    1.801342e-04               0       0.1477240     0.4741187</span></span>
<span><span class="co">## 3  0.003468379    5.513012e-04               0       0.1654821     0.3980812</span></span>
<span><span class="co">## 4  0.091612804    3.379592e-05               0       0.1114058     0.1799783</span></span>
<span><span class="co">## 5  0.032498677    7.233344e-04               0       0.1504639     0.4868485</span></span>
<span><span class="co">## 6  0.156477164    4.864445e-04               0       0.1150491     0.3581561</span></span>
<span><span class="co">##   HerbTranspiration InterflowBalance BaseflowBalance AquiferExfiltration</span></span>
<span><span class="co">## 1                 0     0.000000e+00    0.000000e+00                   0</span></span>
<span><span class="co">## 2                 0     1.261617e-18    7.010353e-19                   0</span></span>
<span><span class="co">## 3                 0    -4.205390e-19   -7.967243e-20                   0</span></span>
<span><span class="co">## 4                 0     1.366752e-18   -2.357318e-19                   0</span></span>
<span><span class="co">## 5                 0     2.418099e-18    3.080941e-18                   0</span></span>
<span><span class="co">## 6                 0    -2.523234e-18    2.312965e-18                   0</span></span>
<span><span class="co">##   WatershedExport</span></span>
<span><span class="co">## 1               0</span></span>
<span><span class="co">## 2               0</span></span>
<span><span class="co">## 3               0</span></span>
<span><span class="co">## 4               0</span></span>
<span><span class="co">## 5               0</span></span>
<span><span class="co">## 6               0</span></span></code></pre>
<p>Values of this output data frame are averages across cells in the
landscape. Data frame <code>watershed_soil_balance</code> is similar to
<code>watershed_balance</code> but focusing on cells that have a soil
(i.e. excluding artificial, rock or water land cover). Finally,
<code>outlet_export_m3</code> contains the volume reaching each outlet
cell per day:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">outlet_export_m3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            6</span></span>
<span><span class="co">## 2001-01-01 0</span></span>
<span><span class="co">## 2001-01-02 0</span></span>
<span><span class="co">## 2001-01-03 0</span></span>
<span><span class="co">## 2001-01-04 0</span></span>
<span><span class="co">## 2001-01-05 0</span></span>
<span><span class="co">## 2001-01-06 0</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="accessing-and-plotting-cell-summaries">Accessing and plotting cell summaries<a class="anchor" aria-label="anchor" href="#accessing-and-plotting-cell-summaries"></a>
</h3>
<p>Unlike <code><a href="../reference/spwb_spatial.html">spwb_spatial()</a></code> where summaries could be
arbitrarily generated <em>a posteriori</em> from simulation results,
with <code><a href="../reference/spwb_land.html">spwb_land()</a></code> the summaries are always fixed and
embedded with the simulation result. For example, we can inspect the
summaries for a given landscape cell using:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">summary</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##            MinTemperature MaxTemperature      PET     Rain     Snow Snowmelt</span></span>
<span><span class="co">## 2001-01-01      -3.203556       2.427977 31.14151 58.09884 16.65065 13.09301</span></span>
<span><span class="co">##            Interception  NetRain Infiltration InfiltrationExcess</span></span>
<span><span class="co">## 2001-01-01     23.59187 34.50697     47.59998                  0</span></span>
<span><span class="co">##            SaturationExcess Runon Runoff DeepDrainage CapillarityRise</span></span>
<span><span class="co">## 2001-01-01                0     0      0   0.06724471      0.01914825</span></span>
<span><span class="co">##            DeepAquiferLoss SoilEvaporation Transpiration HerbTranspiration</span></span>
<span><span class="co">## 2001-01-01               0        1.871379      8.201289                 0</span></span>
<span><span class="co">##            InterflowInput InterflowOutput InterflowBalance BaseflowInput</span></span>
<span><span class="co">## 2001-01-01       8.981441        6.286178         2.695263    0.08810134</span></span>
<span><span class="co">##            BaseflowOutput BaseflowBalance AquiferExfiltration      SWE  SoilVol</span></span>
<span><span class="co">## 2001-01-01     0.04537401      0.04272733                   0 1.699603 564.6947</span></span>
<span><span class="co">##                 RWC    WTD      DTA</span></span>
<span><span class="co">## 2001-01-01 104.9314 3663.3 15.49928</span></span></code></pre>
<p>Several plots can be drawn from the result of function
<code><a href="../reference/spwb_land.html">spwb_land()</a></code> in a similar way as done for
<code><a href="../reference/spwb_spatial.html">spwb_spatial()</a></code>. As an example we display a map of the
average soil relative water content during the simulated month:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"RWC"</span>, date <span class="op">=</span> <span class="st">"2001-01-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-15-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="full-simulation-results-for-specific-cells">Full simulation results for specific cells<a class="anchor" aria-label="anchor" href="#full-simulation-results-for-specific-cells"></a>
</h3>
<p>The idea of generating summaries arises from the fact that local
models can produce a large amount of results, of which only some are of
interest at the landscape level. Nevertheless, it is possible to specify
those cells for which full daily results are desired. This is done by
adding a column <code>result_cell</code> in the input <code>sf</code>
object:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set request for daily model results in cells number 3 and 9</span></span>
<span><span class="va">example_simplified</span><span class="op">$</span><span class="va">result_cell</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">example_simplified</span><span class="op">$</span><span class="va">result_cell</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">9</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<p>If we launch the simulations again (omitting progress
information):</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_simplified</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>We can now retrieve the results of the desired cell, e.g. the third
one, in column <code>result</code> of <code>sf</code>:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">S</span> <span class="op">&lt;-</span> <span class="va">res_ws1</span><span class="op">$</span><span class="va">sf</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "spwb" "list"</span></span></code></pre>
<p>This object has class <code>spwb</code> and the same structure
returned by function <code><a href="https://emf-creaf.github.io/medfate/reference/spwb.html" class="external-link">spwb()</a></code> of <strong>medfate</strong>.
Hence, we can inspect daily results using functions
<code><a href="https://emf-creaf.github.io/medfate/reference/shinyplot.html" class="external-link">shinyplot()</a></code> or <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, for example:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">S</span>, <span class="st">"SoilRWC"</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="continuing-a-previous-simulation">Continuing a previous simulation<a class="anchor" aria-label="anchor" href="#continuing-a-previous-simulation"></a>
</h3>
<p>The result of a simulation includes an element <code>state</code>,
which stores the state of soil and stand variables at the end of the
simulation. This information can be used to perform a new simulation
from the point where the first one ended. In order to do so, we need to
update the state variables in spatial object with their values at the
end of the simulation, using function
<code><a href="../reference/update_landscape.html">update_landscape()</a></code>:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_watershed_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_landscape.html">update_landscape</a></span><span class="op">(</span><span class="va">example_watershed</span>, <span class="va">res_ws1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">example_watershed_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "geometry"             "id"                   "elevation"           </span></span>
<span><span class="co">##  [4] "slope"                "aspect"               "land_cover_type"     </span></span>
<span><span class="co">##  [7] "forest"               "soil"                 "state"               </span></span>
<span><span class="co">## [10] "depth_to_bedrock"     "bedrock_conductivity" "bedrock_porosity"    </span></span>
<span><span class="co">## [13] "snowpack"             "aquifer"              "crop_factor"</span></span></code></pre>
<p>Note that a new column <code>state</code> appears in now in the
<strong>sf</strong> object. We can check the effect by drawing the
relative water content:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed_mod</span>, variable <span class="op">=</span> <span class="st">"soil_rwc_curr"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-21-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Now we can continue our simulation, in this case adding an extra
month:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-02-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-02-28"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_mod</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The fact that no cell required initialization is an indication that
we used an already initialized landscape.</p>
</div>
<div class="section level3">
<h3 id="burn-in-periods">Burn-in periods<a class="anchor" aria-label="anchor" href="#burn-in-periods"></a>
</h3>
<p>Like other distributed hydrological models, watershed simulations
with <strong>medfateland</strong> will normally require a burn-in period
to allow soil moisture and aquifer levels to reach a dynamic
equilibrium. We recommend users to use at least one or two years of
burn-in period, but this will depend on the size of the watershed. In
<strong>medfate</strong> we provide users with a copy of the example
watershed, where burn-in period has already been simulated. This can be
seen by inspecting the aquifer level:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_watershed_burnin"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">example_watershed_burnin</span>, variable <span class="op">=</span> <span class="st">"aquifer"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;"></p>
<p>If we run a one-month simulation on this data set we can then compare
the output before and after the burn-in period to illustrate its
importance:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-31"</span><span class="op">)</span>, by<span class="op">=</span><span class="st">"day"</span><span class="op">)</span></span>
<span><span class="va">res_ws3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>,</span>
<span>                    <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>, dates <span class="op">=</span> <span class="va">dates</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                    watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"before"</span> <span class="op">=</span> <span class="va">res_ws1</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">$</span><span class="va">WatershedExport</span>, </span>
<span>           <span class="st">"after"</span> <span class="op">=</span> <span class="va">res_ws3</span><span class="op">$</span><span class="va">watershed_balance</span><span class="op">$</span><span class="va">WatershedExport</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    before     after</span></span>
<span><span class="co">## 1       0 0.3919421</span></span>
<span><span class="co">## 2       0 0.3735054</span></span>
<span><span class="co">## 3       0 0.3159414</span></span>
<span><span class="co">## 4       0 0.4078490</span></span>
<span><span class="co">## 5       0 0.3747723</span></span>
<span><span class="co">## 6       0 0.5910156</span></span>
<span><span class="co">## 7       0 0.3912692</span></span>
<span><span class="co">## 8       0 0.3090847</span></span>
<span><span class="co">## 9       0 0.2990688</span></span>
<span><span class="co">## 10      0 0.5196032</span></span>
<span><span class="co">## 11      0 0.4713160</span></span>
<span><span class="co">## 12      0 0.4906221</span></span>
<span><span class="co">## 13      0 0.3791076</span></span>
<span><span class="co">## 14      0 0.3466819</span></span>
<span><span class="co">## 15      0 0.3320859</span></span>
<span><span class="co">## 16      0 0.3274119</span></span>
<span><span class="co">## 17      0 0.3233133</span></span>
<span><span class="co">## 18      0 0.3215660</span></span>
<span><span class="co">## 19      0 0.3216506</span></span>
<span><span class="co">## 20      0 0.3348499</span></span>
<span><span class="co">## 21      0 0.4503192</span></span>
<span><span class="co">## 22      0 0.5284060</span></span>
<span><span class="co">## 23      0 0.3833154</span></span>
<span><span class="co">## 24      0 0.3571596</span></span>
<span><span class="co">## 25      0 0.3646311</span></span>
<span><span class="co">## 26      0 0.3380275</span></span>
<span><span class="co">## 27      0 0.3501502</span></span>
<span><span class="co">## 28      0 0.3377115</span></span>
<span><span class="co">## 29      0 0.3339390</span></span>
<span><span class="co">## 30      0 0.3246624</span></span>
<span><span class="co">## 31      0 0.3358968</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulations-of-watershed-forest-dynamics">Simulations of watershed forest dynamics<a class="anchor" aria-label="anchor" href="#simulations-of-watershed-forest-dynamics"></a>
</h3>
<p>Running <code><a href="../reference/spwb_land.html">growth_land()</a></code> is very similar to running
<code><a href="../reference/spwb_land.html">spwb_land()</a></code>. However, a few things change when we want to
simulate forest dynamics using <code><a href="../reference/spwb_land.html">fordyn_land()</a></code>. Regarding the
<code>sf</code> input, an additional column
<code>management_arguments</code> may be defined to specify the forest
management arguments (i.e. silviculture) of cells. Furthermore, the
function does not allow choosing the temporal scale of summaries. Strong
simplification of forest structure to dominant species will not normally
make sense in this kind of simulation, since the focus is on forest
dynamics.</p>
<p>A call to <code><a href="../reference/spwb_land.html">fordyn_land()</a></code> for a single year is given here,
as an example, starting from the initial example watershed:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">fordyn_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed</span>,</span>
<span>                       <span class="va">SpParamsMED</span>, <span class="va">examplemeteo</span>,</span>
<span>                       watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In this case, the <code>sf</code> part of the output contains
additional columns, analogous to those of
<code><a href="../reference/fordyn_scenario.html">fordyn_scenario()</a></code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res_ws4</span><span class="op">$</span><span class="va">sf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "geometry"         "state"            "aquifer"          "snowpack"        </span></span>
<span><span class="co">##  [5] "summary"          "forest"           "tree_table"       "shrub_table"     </span></span>
<span><span class="co">##  [9] "dead_tree_table"  "dead_shrub_table" "cut_tree_table"   "cut_shrub_table"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulations-using-weather-interpolation">Simulations using weather interpolation<a class="anchor" aria-label="anchor" href="#simulations-using-weather-interpolation"></a>
</h3>
<p>Large watersheds will have spatial differences in climatic conditions
like temperature, precipitation. Specifying a single weather data frame
for all the watershed may be not suitable in this case. Specifying a
different weather data frame for each watershed cell can also be a
problem, if spatial resolution is high, due to the huge data
requirements. A solution for this can be using interpolation on the fly,
inside watershed simulations. This can be done by supplying an
<strong>interpolator</strong> object (or a list of them), as defined in
package <strong>meteoland</strong>. Here we use the example data
provided in the package:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interpolator</span> <span class="op">&lt;-</span> <span class="fu">meteoland</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/meteoland/man/with_meteo.html" class="external-link">with_meteo</a></span><span class="op">(</span><span class="va">meteoland_meteo_example</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">meteoland</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/meteoland/man/create_meteo_interpolator.html" class="external-link">create_meteo_interpolator</a></span><span class="op">(</span>params <span class="op">=</span> <span class="fu">defaultInterpolationParams</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Creating interpolator...</span></span></code></pre>
<pre><code><span><span class="co">## • Calculating smoothed variables...</span></span></code></pre>
<pre><code><span><span class="co">## • Updating intial_Rp parameter with the actual stations mean distance...</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Interpolator created.</span></span></code></pre>
<p>Once we have this object, using it is straightforward:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>, <span class="va">SpParamsMED</span>, </span>
<span>                     meteo <span class="op">=</span> <span class="va">interpolator</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                     watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Note that we did not define dates, which are taken from the
interpolator data. If we plot the minimum temperature, we will
appreciate the spatial variation in climate:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws5</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"MinTemperature"</span>, date <span class="op">=</span> <span class="st">"2022-04-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;"></p>
<p>For large watersheds and fine spatial resolution interpolation can
become slow. One can then specify that interpolation is performed on a
coarser grid, by using a watershed control parameter, for example:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws_control</span><span class="op">$</span><span class="va">weather_aggregation_factor</span> <span class="op">&lt;-</span> <span class="fl">3</span></span></code></pre></div>
<p>To illustrate its effect, we repeat the previous simulation and plot
the minimum temperature:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_ws6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spwb_land.html">spwb_land</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed_burnin</span>, <span class="va">SpParamsMED</span>, </span>
<span>                     meteo <span class="op">=</span> <span class="va">interpolator</span>, summary_frequency <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                     watershed_control <span class="op">=</span> <span class="va">ws_control</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_summary.html">plot_summary</a></span><span class="op">(</span><span class="va">res_ws6</span><span class="op">$</span><span class="va">sf</span>, variable <span class="op">=</span> <span class="st">"MinTemperature"</span>, date <span class="op">=</span> <span class="st">"2022-04-01"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></code></pre></div>
<p><img src="WatershedSimulations_files/figure-html/unnamed-chunk-31-1.png" width="672" style="display: block; margin: auto;"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Miquel De Cáceres, Aitor Améztegui, María González, Núria Aquilué, Daniel Caviedes-Voullième, Mario Morales-Hernández.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
