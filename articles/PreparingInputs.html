<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preparing inputs • medfateland</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preparing inputs">
<meta property="og:description" content="medfateland">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">medfateland</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preparing inputs</h1>
                        <h4 data-toc-skip class="author">Miquel De
Cáceres / Núria Aquilué</h4>
            
            <h4 data-toc-skip class="date">2024-05-11</h4>
      
      
      <div class="hidden name"><code>PreparingInputs.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="aim">Aim<a class="anchor" aria-label="anchor" href="#aim"></a>
</h2>
<p>This vignette has been created to illustrate the creation of spatial
inputs to be used in model simulations with the package, starting from a
set of coordinates. The functions introduced in this document are meant
to be executed sequentially to progressively add spatial information,
but users are free to use them in the most convenient way.</p>
<p>Before reading this vignette, users should be familiar with
<em>forest</em> and <em>soil</em> structures in package
<strong>medfate</strong>. Moreover, a brief introduction to spatial
structures used in <strong>medfateland</strong> package is given in
vignette <a href="https://emf-creaf.github.io/medfateland/articles/PackageOverview.html" class="external-link">Package
overview</a> and examples are given in vignettes <a href="https://emf-creaf.github.io/medfateland/articles/SpatiallyUncoupledSimulations.html" class="external-link">Spatially-uncoupled
simulations</a> and <a href="https://emf-creaf.github.io/medfateland/articles/WatershedSimulations.html" class="external-link">Watershed
simulations</a>.</p>
<p>Let’s first load necessary libraries.</p>
<pre><code><span><span class="co">## Package 'medfate' [ver. 4.2.0]</span></span></code></pre>
<pre><code><span><span class="co">## Package 'medfateland' [ver. 2.3.0]</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'tidyterra'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="target-area">Target area<a class="anchor" aria-label="anchor" href="#target-area"></a>
</h2>
<p>Any spatial data set should begin with the definition of spatial
elements. Here we will use a watershed in Catalonia as example, which we
will describe using cells of 200 m in EPSG:32631 (UTM for fuse 31)
projection.</p>
<p>First we load a polygon data set describing watersheds in Spain and
select our target watershed (Riera de Bianya [river code
“2005528”]):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataset_path</span> <span class="op">&lt;-</span> <span class="st">"~/OneDrive/EMF_datasets/"</span></span>
<span><span class="va">scchh</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Hydrography/Sources/Spain/CuencasMedNorte_Pfafs/M_cuencas_rios_Med_Norte.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">watershed</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">scchh</span><span class="op">[</span><span class="va">scchh</span><span class="op">$</span><span class="va">pfafrio</span> <span class="op">==</span><span class="st">"2005528"</span>,<span class="op">]</span>, <span class="st">"epsg:25831"</span><span class="op">)</span></span>
<span><span class="va">watershed</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 1, 8  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : 444922.8, 459850.8, 4668354, 4678487  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">##  names       : OBJECTID COD_MAR cod_uni pfafrio       nom_rio_1 Cuen_Tipo</span></span>
<span><span class="co">##  type        :    &lt;int&gt;   &lt;chr&gt;   &lt;int&gt;   &lt;chr&gt;           &lt;chr&gt;     &lt;chr&gt;</span></span>
<span><span class="co">##  values      :    63564       M 1001395 2005528 RIERA DE BIANYA        NA</span></span>
<span><span class="co">##  Shape_Leng Shape_Area</span></span>
<span><span class="co">##       &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">##   4.905e+04  1.024e+08</span></span></code></pre>
<p>We can draw a map with the location of the watershed within Catalonia
using:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dataset_path</span> <span class="op">&lt;-</span> <span class="st">"~/OneDrive/EMF_datasets/"</span></span>
<span><span class="va">counties</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"PoliticalBoundaries/Sources/Catalunya/Comarques/comarques.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>data <span class="op">=</span> <span class="va">counties</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-3-1.png" width="480" style="display: block; margin: auto;"></p>
<p>Now we define a raster at 200 m resolution, including the target
area. We intersect it with the watershed boundaries to keep the target
locations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">watershed</span><span class="op">)</span>, resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">res</span>,<span class="va">res</span><span class="op">)</span>, crs <span class="op">=</span> <span class="st">"epsg:25831"</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/intersect.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.points.html" class="external-link">as.points</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>, <span class="va">watershed</span><span class="op">)</span></span></code></pre></div>
<p>And finally we transform the result into a <code>sf</code>
object:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">[</span>,<span class="st">"geometry"</span><span class="op">]</span></span>
<span><span class="va">x</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2550 features and 0 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.8 ymin: 4668454 xmax: 459822.8 ymax: 4678454</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##                    geometry</span></span>
<span><span class="co">## 1  POINT (450222.8 4678454)</span></span>
<span><span class="co">## 2  POINT (449422.8 4678254)</span></span>
<span><span class="co">## 3  POINT (449622.8 4678254)</span></span>
<span><span class="co">## 4  POINT (449822.8 4678254)</span></span>
<span><span class="co">## 5  POINT (450022.8 4678254)</span></span>
<span><span class="co">## 6  POINT (450222.8 4678254)</span></span>
<span><span class="co">## 7  POINT (450422.8 4678254)</span></span>
<span><span class="co">## 8  POINT (450622.8 4678254)</span></span>
<span><span class="co">## 9  POINT (450822.8 4678254)</span></span>
<span><span class="co">## 10 POINT (451022.8 4678254)</span></span></code></pre>
<p>We will use the raster definition for plots.</p>
</div>
<div class="section level2">
<h2 id="topography-and-land-cover-type">Topography and land cover type<a class="anchor" aria-label="anchor" href="#topography-and-land-cover-type"></a>
</h2>
<p>Once an object <code>sf</code> has been defined with target
locations, we need to determine topographic features (elevation, slope,
aspect) and land cover corresponding to those locations. You should have
access to a Digital Elevation Model (DEM) at a desired resolution. Here
we will use a DEM raster for Catalonia at 30 m resolution, which we load
using package <code>terra</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Topography/Products/Catalunya/MET30m_ETRS89_UTM31_ICGC.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dem</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 9282, 9391, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 30, 30  (x, y)</span></span>
<span><span class="co">## extent      : 258097.5, 539827.5, 4485488, 4763948  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : MET30m_ETRS89_UTM31_ICGC.tif </span></span>
<span><span class="co">## name        : met15v20as0f0118Bmr1r050 </span></span>
<span><span class="co">## min value   :                   -7.120 </span></span>
<span><span class="co">## max value   :                 3133.625</span></span></code></pre>
<p>Similarly, you should have downloaded a land cover map, in this case
we will use a land cover raster for Catalonia, issued in 2018:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lcm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"LandCover/Sources/Catalunya/cobertes-sol-v1r0-2018.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lcm</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 259198, 267234, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 1, 1  (x, y)</span></span>
<span><span class="co">## extent      : 260170, 527404, 4488784, 4747982  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : cobertes-sol-v1r0-2018.tif </span></span>
<span><span class="co">## color table : 1 </span></span>
<span><span class="co">## name        : cobertes-sol-v1r0-2018</span></span></code></pre>
<p>You should examine the legend of their land cover map and decide how
to map legend elements to the five land cover types used in
<strong>medfateland</strong>. After inspecting our land cover map
legend, we define the following vectors to perform the legend
mapping:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agriculture</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="va">wildland</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span><span class="op">:</span><span class="fl">17</span>,<span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">rock</span> <span class="op">&lt;-</span> <span class="fl">18</span><span class="op">:</span><span class="fl">19</span></span>
<span><span class="va">artificial</span> <span class="op">&lt;-</span> <span class="fl">21</span><span class="op">:</span><span class="fl">35</span></span>
<span><span class="va">water</span> <span class="op">&lt;-</span> <span class="fl">36</span><span class="op">:</span><span class="fl">41</span></span></code></pre></div>
<p>Having these inputs, we can use function
<code><a href="../reference/create_landscape.html">create_landscape()</a></code> to add topographic and land cover
features to our starting <code>sf</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_landscape.html">create_landscape</a></span><span class="op">(</span><span class="va">x</span>, dem <span class="op">=</span> <span class="va">dem</span>, land_cover_map <span class="op">=</span> <span class="va">lcm</span>, </span>
<span>                        wildland <span class="op">=</span> <span class="va">wildland</span>, </span>
<span>                        agriculture <span class="op">=</span> <span class="va">agriculture</span>, </span>
<span>                        rock <span class="op">=</span> <span class="va">rock</span>, </span>
<span>                        artificial <span class="op">=</span> <span class="va">artificial</span>, </span>
<span>                        water <span class="op">=</span> <span class="va">water</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </span></span></code></pre>
<p>We can examine the result using:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_1</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2550 features and 5 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.8 ymin: 4668454 xmax: 459822.8 ymax: 4678454</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,550 × 6</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (450222.8 4678454)     1      886.  9.62   66.7 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449422.8 4678254)     2     <span style="text-decoration: underline;">1</span>000.  6.86   45.2 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (449622.8 4678254)     3      932. 32.8   134.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (449822.8 4678254)     4      853. 20.8   164.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450022.8 4678254)     5      832. 22.6   154.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450222.8 4678254)     6      811. 29.6   137.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (450422.8 4678254)     7      792. 30.7   195.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (450622.8 4678254)     8      831. 21.4   146.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (450822.8 4678254)     9      822. 27.6   234.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (451022.8 4678254)    10      846. 28.0   185.  wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,540 more rows</span></span></span></code></pre>
<p>We can now examine the elevation of the area, using the raster
<code>r</code> to draw cells instead of points:</p>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
<p>and the land cover types:</p>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-14-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="forest-parameterization">Forest parameterization<a class="anchor" aria-label="anchor" href="#forest-parameterization"></a>
</h2>
<p>The next step is to define <code>forest</code> objects for our
simulations. Forests should be defined for all target locations whose
land cover is defined as <code>wildland</code>. When forest inventory
plots are not be available for the target locations, one must resort on
imputations.</p>
<ol style="list-style-type: decimal">
<li>Forest inventory data from nearby locations. National forest
inventories are ideal in this respect.</li>
<li>A forest map where polygons or raster cells describe the
distribution of forest (or shrubland) types.</li>
<li>Raster source of vegetation structure (i.e. mean tree height or
basal area), derived from aerial or satellite LiDAR missions.</li>
</ol>
<p>Our task here will be to perform imputations of forest inventory
plots to our target locations according to some criteria and, if
possible, to correct the forest structure on those locations according
to available data.</p>
<div class="section level3">
<h3 id="forest-imputation">Forest imputation<a class="anchor" aria-label="anchor" href="#forest-imputation"></a>
</h3>
<p>A map of forest types in the target area is important to determine
dominant tree or shrub species. We start by loading the Spanish Forest
Map (1:25000) for the region of Catalonia, which is in vector format,
using package <code>terra</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"ForestMaps/Products/Catalunya/mfe25_cat_class.shp"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forest_map</span></span></code></pre></div>
<pre><code><span><span class="co">##  class       : SpatVector </span></span>
<span><span class="co">##  geometry    : polygons </span></span>
<span><span class="co">##  dimensions  : 238096, 1  (geometries, attributes)</span></span>
<span><span class="co">##  extent      : 0.1591812, 3.332506, 40.523, 42.86144  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">##  source      : mfe25_cat_class.shp</span></span>
<span><span class="co">##  coord. ref. : lon/lat ETRS89 (EPSG:4258) </span></span>
<span><span class="co">##  names       :              Class</span></span>
<span><span class="co">##  type        :              &lt;chr&gt;</span></span>
<span><span class="co">##  values      : Pinus halepensis_2</span></span>
<span><span class="co">##                Pinus halepensis_2</span></span>
<span><span class="co">##                Pinus halepensis_2</span></span></code></pre>
<p>Second, we need forest inventory data for imputations. Arguably, this
is the hardest part. Let’s assume one has access to a such data already
in format for package <em>medfateland</em> (how to build such data set
will be illustrated in a different vignette). We also load an
<code>sf_nfi</code> object that contains coordinates and forest objects
corresponding to the <a href="https://www.miteco.gob.es/es/biodiversidad/temas/inventarios-nacionales/inventario-forestal-nacional/cuarto_inventario.html" class="external-link">Fourth
Spanish Forest Inventory</a> for Catalonia (5509 forest plots):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nfi_path</span> <span class="op">&lt;-</span> <span class="st">"/home/miquel/OneDrive/mcaceres_work/model_initialisation/medfate_initialisation/IFN/"</span></span>
<span><span class="va">sf_nfi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">nfi_path</span>, <span class="st">"Products/IFN4/Catalunya/IFN4_cat_final_ETRS89H31.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf_nfi</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 5509 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 260943 ymin: 4491797 xmax: 518928 ymax: 4744883</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 5,509 × 15</span></span></span>
<span><span class="co">##    Provincia Estadillo Clase Subclase IDPARCELA IDCLASE ID       id    elevation</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 08        0001      A     1        080001    A1      080001_… 0800…      <span style="text-decoration: underline;">1</span>814</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 08        0002      A     1        080002    A1      080002_… 0800…      <span style="text-decoration: underline;">1</span>797</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 08        0003      A     1        080003    A1      080003_… 0800…      <span style="text-decoration: underline;">1</span>657</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 08        0004      A     1        080004    A1      080004_… 0800…      <span style="text-decoration: underline;">1</span>403</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 08        0005      A     1        080005    A1      080005_… 0800…      <span style="text-decoration: underline;">1</span>371</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 08        0006      A     1        080006    A1      080006_… 0800…      <span style="text-decoration: underline;">1</span>683</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 08        0009      A     4        080009    A4      080009_… 0800…      <span style="text-decoration: underline;">1</span>041</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 08        0014      A     1        080014    A1      080014_… 0800…      <span style="text-decoration: underline;">1</span>538</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 08        0016      A     4        080016    A4      080016_… 0800…      <span style="text-decoration: underline;">1</span>743</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 08        0020      A     1        080020    A1      080020_… 0800…      <span style="text-decoration: underline;">1</span>404</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5,499 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 6 more variables: slope &lt;dbl&gt;, aspect &lt;dbl&gt;, soil &lt;list&gt;, forest &lt;list&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   forest_allrecords &lt;named list&gt;, geom &lt;POINT [m]&gt;</span></span></span></code></pre>
<p>Note that this is already an <code>sf</code> object suitable for
simulations, but refers to the locations of the forest inventory plots,
not to our target area.</p>
<p>Having these two inputs (forest map and forest inventory data), we
can use function <code><a href="../reference/forest_parametrization.html">impute_forests()</a></code> to perform the imputation
for us (this normally takes some time):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forest_parametrization.html">impute_forests</a></span><span class="op">(</span><span class="va">y_1</span>, sf_nfi <span class="op">=</span> <span class="va">sf_nfi</span>, dem <span class="op">=</span> <span class="va">dem</span>, </span>
<span>                      forest_map <span class="op">=</span> <span class="va">forest_map</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          |---------|---------|---------|---------|=========================================                                          </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> 9 forest classes were not represented in nfi data and the class of 113 locations was set to missing</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Missing forest class for 242 locations. Only geographic and topographic criteria used for those locations.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Not enough plots of the same class within geographic distance limits for 21 locations. The closest plot of the same class was chosen in those cases.</span></span></code></pre>
<p>For each target location, the function selects forest inventory plots
that correspond to the same forest class, defined in the forest map, and
are geographically closer than a pre-specified maximum distance. Among
the multiple plots that can fulfill this criterion, the function chooses
the plot that has the most similar elevation and position in the N-to-S
slopes (i.e. the product of the cosine of aspect and slope). Warnings
and errors can arise in the process. More details can be found in the
documentation of <code><a href="../reference/forest_parametrization.html">impute_forests()</a></code>.</p>
<p>The resulting <code>sf</code> has an extra column named
<code>forest</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2550 features and 6 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.8 ymin: 4668454 xmax: 459822.8 ymax: 4678454</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,550 × 7</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (450222.8 4678454)     1      886.  9.62   66.7 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449422.8 4678254)     2     <span style="text-decoration: underline;">1</span>000.  6.86   45.2 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (449622.8 4678254)     3      932. 32.8   134.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (449822.8 4678254)     4      853. 20.8   164.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450022.8 4678254)     5      832. 22.6   154.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450222.8 4678254)     6      811. 29.6   137.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (450422.8 4678254)     7      792. 30.7   195.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (450622.8 4678254)     8      831. 21.4   146.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (450822.8 4678254)     9      822. 27.6   234.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (451022.8 4678254)    10      846. 28.0   185.  wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,540 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 1 more variable: forest &lt;list&gt;</span></span></span></code></pre>
<p>Only <code>wildland</code> locations will have a <code>forest</code>
object, for example:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_2</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##            Species       DBH    Height          N      Z50  Z95</span></span>
<span><span class="co">## 1     Quercus ilex 30.950000  990.0000   14.14711 702.5790 5020</span></span>
<span><span class="co">## 2     Quercus ilex 24.653871 1081.7076   84.88264 702.5790 5020</span></span>
<span><span class="co">## 3  Quercus petraea 24.950000 1130.0000   14.14711 209.3124 1040</span></span>
<span><span class="co">## 4     Quercus ilex 19.638126  947.9476  318.30989 702.5790 5020</span></span>
<span><span class="co">## 5  Quercus petraea 19.318709  831.5934   63.66198 209.3124 1040</span></span>
<span><span class="co">## 6     Quercus ilex 15.219907  822.3270  572.95780 702.5790 5020</span></span>
<span><span class="co">## 7  Quercus petraea 14.553801  893.6430  127.32395 209.3124 1040</span></span>
<span><span class="co">## 8     Quercus ilex  9.163617  588.0669 1018.59164 702.5790 5020</span></span>
<span><span class="co">## 9  Quercus petraea  8.850000  600.0000  127.32395 209.3124 1040</span></span>
<span><span class="co">## 10    Quercus ilex  5.000000  300.0000 1018.59164 702.5790 5020</span></span>
<span><span class="co">## 11 Quercus petraea  5.000000  400.0000  127.32395 209.3124 1040</span></span>
<span><span class="co">## 12  Crataegus spp.  1.500000  100.0000  318.30989 456.0124 2862</span></span>
<span><span class="co">## 13    Quercus ilex  1.500000  100.0000 1273.23955 702.5790 5020</span></span>
<span><span class="co">## 14 Quercus petraea  1.500000  100.0000  318.30989 209.3124 1040</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##         Species Cover Height      Z50  Z95</span></span>
<span><span class="co">## 1  Hedera helix     5    200 173.0294  812</span></span>
<span><span class="co">## 2 Erica arborea     5    160 346.1416 2000</span></span>
<span><span class="co">## 3 Lonicera spp.     2    150 392.2431 2353</span></span>
<span><span class="co">## 4   Prunus spp.     2     50 541.3475 3577</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="structure-correction">Structure correction<a class="anchor" aria-label="anchor" href="#structure-correction"></a>
</h3>
<p>The former imputation result would be already useful for simulations,
but the forest structure in the target locations can be very different
than that of the forest inventory used as reference, even if the forest
types are the same. Therefore, it is advisable to correct the forest
structure with available information.</p>
<p>There are several global products made recently available, that
combine satellite LiDAR observations with other information, such as <a href="https://doi.org/10.1029/2011JG001708" class="external-link">Simard et al. (2011)</a>, <a href="https://doi.org/10.1016/j.rse.2020.112165" class="external-link">Potapov et
al. (2021)</a> or <a href="https://doi.org/10.1038/s41559-023-02206-6" class="external-link">Lang et
al. (2023)</a>. Alternatively, airborne LiDAR products are available for
some countries and regions. Here we will use structural information
derived from LiDAR flights in Catalonia (years 2016-2017). First we will
load a mean tree height raster at 20-m resolution:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"RemoteSensing/Sources/Catalunya/Lidar/VariablesBiofisiques/RastersComplets/2016-2017/variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">height_map</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 13100, 13400, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 20, 20  (x, y)</span></span>
<span><span class="co">## extent      : 260000, 528000, 4488000, 4750000  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017.tif </span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017</span></span></code></pre>
<p>This resolution is a bit finer than the size of forest inventory
plots. Hence, we aggregate the raster to the 40m resolution, while we
crop to the target area:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map_40</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">height_map</span>, <span class="va">r</span><span class="op">)</span>, </span>
<span>                                  fact <span class="op">=</span> <span class="fl">2</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">height_map_40</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 255, 375, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 40, 40  (x, y)</span></span>
<span><span class="co">## extent      : 444920, 459920, 4668360, 4678560  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-hmitjana-2016-2017 </span></span>
<span><span class="co">## min value   :                                                3.965 </span></span>
<span><span class="co">## max value   :                                               25.000</span></span></code></pre>
<p>Mean tree height data has the following distribution:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">height_map_40</span><span class="op">)</span><span class="op">&lt;-</span> <span class="st">"height"</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">height</span><span class="op">)</span>, data<span class="op">=</span><span class="va">height_map_40</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m"</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-22-1.png" width="576"></p>
<p>We now call function <code><a href="../reference/forest_parametrization.html">modify_forest_structure()</a></code> to
correct mean tree height according to the LiDAR data (Note the
correction of units: tree heights are in cm in
<strong>medfate</strong>):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">height_map_40_cm</span> <span class="op">&lt;-</span> <span class="va">height_map_40</span><span class="op">*</span><span class="fl">100</span></span>
<span><span class="va">y_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forest_parametrization.html">modify_forest_structure</a></span><span class="op">(</span><span class="va">y_2</span>, <span class="va">height_map_40_cm</span>, var <span class="op">=</span> <span class="st">"mean_tree_height"</span>,</span>
<span>                               progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Correction of tree heights also affects tree diameters, because the
function assumes that the diameter-height relationship needs to be
preserved. If we inspect the same <code>forest</code> object again, we
will be able to note changes in height and diameter values:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_3</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##            Species       DBH    Height          N      Z50  Z95</span></span>
<span><span class="co">## 1     Quercus ilex 38.593251 1234.4853   14.14711 702.5790 5020</span></span>
<span><span class="co">## 2     Quercus ilex 30.742262 1348.8405   84.88264 702.5790 5020</span></span>
<span><span class="co">## 3  Quercus petraea 31.111522 1409.0589   14.14711 209.3124 1040</span></span>
<span><span class="co">## 4     Quercus ilex 24.487856 1182.0479  318.30989 702.5790 5020</span></span>
<span><span class="co">## 5  Quercus petraea 24.089557 1036.9594   63.66198 209.3124 1040</span></span>
<span><span class="co">## 6     Quercus ilex 18.978536 1025.4046  572.95780 702.5790 5020</span></span>
<span><span class="co">## 7  Quercus petraea 18.147932 1114.3324  127.32395 209.3124 1040</span></span>
<span><span class="co">## 8     Quercus ilex 11.426616  733.2928 1018.59164 702.5790 5020</span></span>
<span><span class="co">## 9  Quercus petraea 11.035550  748.1729  127.32395 209.3124 1040</span></span>
<span><span class="co">## 10    Quercus ilex  6.234774  374.0864 1018.59164 702.5790 5020</span></span>
<span><span class="co">## 11 Quercus petraea  6.234774  498.7819  127.32395 209.3124 1040</span></span>
<span><span class="co">## 12  Crataegus spp.  1.870432  124.6955  318.30989 456.0124 2862</span></span>
<span><span class="co">## 13    Quercus ilex  1.870432  124.6955 1273.23955 702.5790 5020</span></span>
<span><span class="co">## 14 Quercus petraea  1.870432  124.6955  318.30989 209.3124 1040</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##         Species Cover Height      Z50  Z95</span></span>
<span><span class="co">## 1  Hedera helix     5    200 173.0294  812</span></span>
<span><span class="co">## 2 Erica arborea     5    160 346.1416 2000</span></span>
<span><span class="co">## 3 Lonicera spp.     2    150 392.2431 2353</span></span>
<span><span class="co">## 4   Prunus spp.     2     50 541.3475 3577</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
<p>Additionally, one may have access to other maps of structural
variables. In our case, we will use a raster of basal area, also derived
from LiDAR flights:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basal_area_map</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"RemoteSensing/Sources/Catalunya/Lidar/VariablesBiofisiques/RastersComplets/2016-2017/variables-biofisiques-arbrat-v1r0-ab-2016-2017.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">basal_area_map</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 13100, 13400, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 20, 20  (x, y)</span></span>
<span><span class="co">## extent      : 260000, 528000, 4488000, 4750000  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source      : variables-biofisiques-arbrat-v1r0-ab-2016-2017.tif </span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-ab-2016-2017</span></span></code></pre>
<p>We perform the same aggregation done for heights:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">basal_area_map_40</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">basal_area_map</span>, <span class="va">r</span><span class="op">)</span>, </span>
<span>                                      fact <span class="op">=</span> <span class="fl">2</span>, fun <span class="op">=</span> <span class="st">"mean"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">basal_area_map_40</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 255, 375, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 40, 40  (x, y)</span></span>
<span><span class="co">## extent      : 444920, 459920, 4668360, 4678560  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : ETRS89 / UTM zone 31N (EPSG:25831) </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## name        : variables-biofisiques-arbrat-v1r0-ab-2016-2017 </span></span>
<span><span class="co">## min value   :                                           3.48 </span></span>
<span><span class="co">## max value   :                                          60.00</span></span></code></pre>
<p>Basal area geographic distribution looks as follows:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">&lt;-</span> <span class="st">"basal_area"</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">basal_area</span><span class="op">)</span>, data<span class="op">=</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m2/ha"</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-27-1.png" width="576"></p>
<p>We now use the same function to correct basal area values (no unit
conversion is needed in this case):</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forest_parametrization.html">modify_forest_structure</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="va">basal_area_map_40</span>, var <span class="op">=</span> <span class="st">"basal_area"</span>,</span>
<span>                               progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Note that basal area (or tree density) corrections should be done
after the height correction, because of the effect that height
correction has on tree diameters. The correction of basal area operates
on tree density values. As before, we can inspect changes in tree
density:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_4</span><span class="op">$</span><span class="va">forest</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $treeData</span></span>
<span><span class="co">##            Species       DBH    Height          N      Z50  Z95</span></span>
<span><span class="co">## 1     Quercus ilex 38.593251 1234.4853   6.189625 702.5790 5020</span></span>
<span><span class="co">## 2     Quercus ilex 30.742262 1348.8405  37.137749 702.5790 5020</span></span>
<span><span class="co">## 3  Quercus petraea 31.111522 1409.0589   6.189625 209.3124 1040</span></span>
<span><span class="co">## 4     Quercus ilex 24.487856 1182.0479 139.266560 702.5790 5020</span></span>
<span><span class="co">## 5  Quercus petraea 24.089557 1036.9594  27.853312 209.3124 1040</span></span>
<span><span class="co">## 6     Quercus ilex 18.978536 1025.4046 250.679808 702.5790 5020</span></span>
<span><span class="co">## 7  Quercus petraea 18.147932 1114.3324  55.706624 209.3124 1040</span></span>
<span><span class="co">## 8     Quercus ilex 11.426616  733.2928 445.652991 702.5790 5020</span></span>
<span><span class="co">## 9  Quercus petraea 11.035550  748.1729  55.706624 209.3124 1040</span></span>
<span><span class="co">## 10    Quercus ilex  6.234774  374.0864 445.652991 702.5790 5020</span></span>
<span><span class="co">## 11 Quercus petraea  6.234774  498.7819  55.706624 209.3124 1040</span></span>
<span><span class="co">## 12  Crataegus spp.  1.870432  124.6955 139.266560 456.0124 2862</span></span>
<span><span class="co">## 13    Quercus ilex  1.870432  124.6955 557.066239 702.5790 5020</span></span>
<span><span class="co">## 14 Quercus petraea  1.870432  124.6955 139.266560 209.3124 1040</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $shrubData</span></span>
<span><span class="co">##         Species Cover Height      Z50  Z95</span></span>
<span><span class="co">## 1  Hedera helix     5    200 173.0294  812</span></span>
<span><span class="co">## 2 Erica arborea     5    160 346.1416 2000</span></span>
<span><span class="co">## 3 Lonicera spp.     2    150 392.2431 2353</span></span>
<span><span class="co">## 4   Prunus spp.     2     50 541.3475 3577</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbCover</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $herbHeight</span></span>
<span><span class="co">## [1] NA</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"class")</span></span>
<span><span class="co">## [1] "forest" "list"</span></span></code></pre>
<p>To finish this section, we will show the effect of imputation and
correction on structural variables, compared with the LiDAR data.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_2</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation"</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation + H correction"</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"basal_area"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation + H/BA correction"</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">basal_area_map_40</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_vect</span><span class="op">$</span><span class="va">basal_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">basal_area_map_40</span>, <span class="va">x_vect</span><span class="op">)</span><span class="op">$</span><span class="va">basal_area</span></span>
<span><span class="va">r_ba</span><span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">x_vect</span>, <span class="va">r</span>, field <span class="op">=</span> <span class="st">"basal_area"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">last</span><span class="op">)</span>, data<span class="op">=</span><span class="va">r_ba</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"m2/ha"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Basal area from Lidar"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-30-1.png" width="768">
where it is apparent that both the height correction and the basal area
correction have an effect in basal area. Note that the map after the two
corrections differs from the LiDAR basal area in locations that have not
been corrected because of missing LiDAR values (or missing tree data).
We can quantitatively assess the relationship between predicted basal
area and the observed one using:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ba_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">extract_variables</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"basal_area"</span><span class="op">)</span><span class="op">$</span><span class="va">basal_area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">ba_4</span>, <span class="va">x_vect</span><span class="op">$</span><span class="va">basal_area</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  ba_4 and x_vect$basal_area</span></span>
<span><span class="co">## t = 80.484, df = 2047, p-value &lt; 2.2e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.8609014 0.8817277</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##       cor </span></span>
<span><span class="co">## 0.8717076</span></span></code></pre>
<p>We can also see the effect of the imputation and correction on mean
tree height:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_2</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_3</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation + H mean_tree_height"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"mean_tree_height"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Imputation + H/BA correction"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">fill</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">fill</span>, which will replace the existing scale.</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">height_map_40_cm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_vect</span><span class="op">$</span><span class="va">height</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">height_map_40_cm</span>, <span class="va">x_vect</span><span class="op">)</span><span class="op">$</span><span class="va">height</span></span>
<span><span class="va">r_ba</span><span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">x_vect</span>, <span class="va">r</span>, field <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatraster</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill<span class="op">=</span><span class="va">last</span><span class="op">)</span>, data<span class="op">=</span><span class="va">r_ba</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_continuous</span><span class="op">(</span><span class="st">"cm"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2600</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"viridis"</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Mean tree height from Lidar"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-32-1.png" width="768">
Here the basal area correction did not have any effect on mean tree
height. The relationship between estimated and predicted mean tree
height is:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mth_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">extract_variables</a></span><span class="op">(</span><span class="va">y_4</span>, <span class="st">"mean_tree_height"</span><span class="op">)</span><span class="op">$</span><span class="va">mean_tree_height</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html" class="external-link">cor.test</a></span><span class="op">(</span><span class="va">mth_4</span>, <span class="va">x_vect</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Pearson's product-moment correlation</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  mth_4 and x_vect$height</span></span>
<span><span class="co">## t = 86.113, df = 2000, p-value &lt; 2.2e-16</span></span>
<span><span class="co">## alternative hypothesis: true correlation is not equal to 0</span></span>
<span><span class="co">## 95 percent confidence interval:</span></span>
<span><span class="co">##  0.8777776 0.8964172</span></span>
<span><span class="co">## sample estimates:</span></span>
<span><span class="co">##       cor </span></span>
<span><span class="co">## 0.8874598</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="soil-parameterization">Soil parameterization<a class="anchor" aria-label="anchor" href="#soil-parameterization"></a>
</h2>
<p>Soil information is most usually lacking for the target locations.
Regional maps of soil properties may be available in some cases. Here we
assume this information is not available, so that we resort to global
products. In particular, we will use information provided in <a href="https://soilgrids.org/" class="external-link">SoilGrids</a> at 250 m resolution.</p>
<div class="section level3">
<h3 id="soilgrids-2-0-data">SoilGrids 2.0 data<a class="anchor" aria-label="anchor" href="#soilgrids-2-0-data"></a>
</h3>
<p>Function <code><a href="../reference/soil_parametrization.html">add_soilgrids()</a></code> can perform queries using the
REST API of SoilGrids, but this becomes problematic for multiple sites.
Hence, we recommend downloading SoilGrid rasters for the target region
and storing them in a particular format, so that function
<code><a href="../reference/soil_parametrization.html">add_soilgrids()</a></code> can read them (check the details of the
function documentation). The extraction of SoilGrids data for our target
cells is rather fast using this approach:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soilgrids_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>,<span class="st">"Soils/Sources/Global/SoilGrids/Spain/"</span><span class="op">)</span></span>
<span><span class="va">y_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/soil_parametrization.html">add_soilgrids</a></span><span class="op">(</span><span class="va">y_4</span>, soilgrids_path <span class="op">=</span> <span class="va">soilgrids_path</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Default 'clay' values assigned for 27 locations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Default 'sand' values assigned for 27 locations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Default 'bd' values assigned for 27 locations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> Default 'rfc' values assigned for 27 locations</span></span></code></pre>
<p>And the result has an extra column <code>soil</code>:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_5</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 2550 features and 7 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 445022.8 ymin: 4668454 xmax: 459822.8 ymax: 4678454</span></span>
<span><span class="co">## Projected CRS: ETRS89 / UTM zone 31N</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 2,550 × 8</span></span></span>
<span><span class="co">##              geometry    id elevation slope aspect land_cover_type</span></span>
<span><span class="co">##           <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> (450222.8 4678454)     1      886.  9.62   66.7 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> (449422.8 4678254)     2     <span style="text-decoration: underline;">1</span>000.  6.86   45.2 wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> (449622.8 4678254)     3      932. 32.8   134.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> (449822.8 4678254)     4      853. 20.8   164.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> (450022.8 4678254)     5      832. 22.6   154.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> (450222.8 4678254)     6      811. 29.6   137.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> (450422.8 4678254)     7      792. 30.7   195.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> (450622.8 4678254)     8      831. 21.4   146.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> (450822.8 4678254)     9      822. 27.6   234.  wildland       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> (451022.8 4678254)    10      846. 28.0   185.  wildland       </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2,540 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2 more variables: forest &lt;list&gt;, soil &lt;list&gt;</span></span></span></code></pre>
<p>The elements of the list are the usual data frames of soil properties
in <strong>medfate</strong>:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_5</span><span class="op">$</span><span class="va">soil</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   widths clay sand   om   bd  rfc nitrogen</span></span>
<span><span class="co">## 1     50 21.9 38.7 8.79 1.12 18.0     5.18</span></span>
<span><span class="co">## 2    100 21.7 39.2 3.79 1.13 21.8     2.51</span></span>
<span><span class="co">## 3    150 23.4 38.0 2.52 1.25 19.7     1.92</span></span>
<span><span class="co">## 4    300 25.6 37.6 1.77 1.43 19.0     1.16</span></span>
<span><span class="co">## 5    400 26.0 39.2 1.37 1.52 20.7     1.05</span></span>
<span><span class="co">## 6   1000 25.7 38.0 0.86 1.54 21.7     0.95</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="soil-depth-and-rock-content-modification">Soil depth and rock content modification<a class="anchor" aria-label="anchor" href="#soil-depth-and-rock-content-modification"></a>
</h3>
<p>SoilGrids 2.0 does not provide information on soil depth, and rock
fragment content is normally underestimated, which leads to an
overestimation of water holding capacity. Function
<code><a href="../reference/soil_parametrization.html">modify_soils()</a></code> allows modifying soil definitions, if
information is available for soil depth, depth to the (unaltered)
bedrock, or both. Soil depth maps are not common in many regions, so
here we will resort on a global product at 250m-resolution by <a href="https://doi.org/10.1002/2016MS000686" class="external-link">Shangguan et al. (2017)</a>,
which consists on three rasters:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Censored soil depth (cm)</span></span>
<span><span class="va">bdricm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDRICM_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Probability of bedrock within first 2m [0-100]</span></span>
<span><span class="va">bdrlog</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDRLOG_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Absolute depth to bedrock (cm)</span></span>
<span><span class="va">bdticm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dataset_path</span>, <span class="st">"Soils/Sources/Global/SoilDepth_Shangguan2017/BDTICM_M_250m_ll.tif"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In order to accelerate raster manipulations, we crop the global
rasters to the extent of the target area:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_vect</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bdricm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_ext</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">x_vect</span><span class="op">)</span></span>
<span><span class="va">bdricm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdricm</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span>
<span><span class="va">bdrlog</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdrlog</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span>
<span><span class="va">bdticm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bdticm</span>, <span class="va">x_ext</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span></span></code></pre></div>
<p>Censored soil depth is a poor product of actual soil depth, but we
have observed a fairly good correlation between soil depth values in
Catalonia and the probability of finding the bedrock within the first
two meters. Hence, we multiply the two layers and use it as a (crude)
estimate of soil depth, expressing it in mm:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil_depth_mm</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bdricm</span><span class="op">$</span><span class="va">BDRICM_M_250m_ll</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="va">bdrlog</span><span class="op">$</span><span class="va">BDRLOG_M_250m_ll</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and we take the depth to bedrock as appropriate, but change its units
to mm as well:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">depth_to_bedrock_mm</span> <span class="op">&lt;-</span> <span class="va">bdticm</span><span class="op">*</span><span class="fl">10</span></span></code></pre></div>
<p>We can now call function <code><a href="../reference/soil_parametrization.html">modify_soils()</a></code> with the two
rasters to perform the correction of soil characteristics:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/soil_parametrization.html">modify_soils</a></span><span class="op">(</span><span class="va">y_5</span>, </span>
<span>                    soil_depth_map <span class="op">=</span> <span class="va">soil_depth_mm</span>, </span>
<span>                    depth_to_bedrock_map <span class="op">=</span> <span class="va">depth_to_bedrock_mm</span>,</span>
<span>                    progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In this case, the depth to bedrock values were deeper than 2m, so
that only the soil depth map had an effect on the correction procedure.
After the correction, the rock fragment content of the soil has changed
substantially:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_6</span><span class="op">$</span><span class="va">soil</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   widths clay sand   om   bd      rfc nitrogen</span></span>
<span><span class="co">## 1     50 21.9 38.7 8.79 1.12 18.00000     5.18</span></span>
<span><span class="co">## 2    100 21.7 39.2 3.79 1.13 21.80000     2.51</span></span>
<span><span class="co">## 3    150 23.4 38.0 2.52 1.25 19.70000     1.92</span></span>
<span><span class="co">## 4    300 25.6 37.6 1.77 1.43 30.89789     1.16</span></span>
<span><span class="co">## 5    400 26.0 39.2 1.37 1.52 54.92958     1.05</span></span>
<span><span class="co">## 6   1000 25.7 38.0 0.86 1.54 97.50000     0.95</span></span></code></pre>
<p>We can compare the effect of the correction on the soil water
capacity (in mm) by inspecting the following plots (note the change in
magnitude and spatial pattern):</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_5</span>, <span class="st">"soilvolextract"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span><span class="st">"mm"</span>, type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"YlGnBu"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title<span class="op">=</span><span class="st">"SoilGrids alone"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_variables.html">plot_variable</a></span><span class="op">(</span><span class="va">y_6</span>, <span class="st">"soilvolextract"</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu">geom_spatvector</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, col <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">0.5</span>, data <span class="op">=</span> <span class="va">watershed</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span><span class="st">"mm"</span>, type <span class="op">=</span> <span class="st">"seq"</span>, palette <span class="op">=</span> <span class="st">"YlGnBu"</span>, direction <span class="op">=</span> <span class="fl">1</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title<span class="op">=</span><span class="st">"SoilGrids + depth correction"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, ncol <span class="op">=</span><span class="fl">1</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="PreparingInputs_files/figure-html/unnamed-chunk-43-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="initialization-test">Initialization test<a class="anchor" aria-label="anchor" href="#initialization-test"></a>
</h2>
<p>We can check whether the input data set is well formed by calling
function <code><a href="../reference/initialize_landscape.html">initialize_landscape()</a></code>:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initialize_landscape.html">initialize_landscape</a></span><span class="op">(</span><span class="va">y_6</span>, <span class="va">SpParamsMED</span>, <span class="fu">defaultControl</span><span class="op">(</span><span class="op">)</span>,</span>
<span>                          progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Other variables may be needed, depending on the simulation function
we want to use (crop factors, bedrock conductivity and porosity, etc.),
but here we illustrated the most important ones.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Miquel De Cáceres, Aitor Améztegui, María González, Núria Aquilué, Daniel Caviedes-Voullième, Mario Morales-Hernández.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
