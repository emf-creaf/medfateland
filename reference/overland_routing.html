<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Overland routing for TETIS sub-model — overland_routing • medfateland</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Overland routing for TETIS sub-model — overland_routing"><meta name="description" content="Determines overland routing given a raster definition and a set of target locations for watershed simulations. If channel is supplied,
it also determines channel routing."><meta property="og:description" content="Determines overland routing given a raster definition and a set of target locations for watershed simulations. If channel is supplied,
it also determines channel routing."><meta property="og:image" content="https://emf-creaf.github.io/medfateland/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">medfateland</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Introduction</h6></li>
    <li><a class="dropdown-item" href="../articles/intro/PackageOverview.html">Package overview</a></li>
    <li><a class="dropdown-item" href="../articles/intro/PreparingInputs_I.html">Preparing inputs I: forest inventory plots</a></li>
    <li><a class="dropdown-item" href="../articles/intro/PreparingInputs_II.html">Preparing inputs II: arbitrary locations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Running simulations</h6></li>
    <li><a class="dropdown-item" href="../articles/runmodels/SpatiallyUncoupledSimulations.html">Spatially-uncoupled simulations</a></li>
    <li><a class="dropdown-item" href="../articles/runmodels/WatershedSimulations.html">Watershed simulations</a></li>
    <li><a class="dropdown-item" href="../articles/runmodels/ManagementScenarios.html">Management scenarios</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/emf-creaf/medfateland/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Overland routing for TETIS sub-model</h1>
      <small class="dont-index">Source: <a href="https://github.com/emf-creaf/medfateland/blob/HEAD/R/overland_routing.R" class="external-link"><code>R/overland_routing.R</code></a></small>
      <div class="d-none name"><code>overland_routing.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Determines overland routing given a raster definition and a set of target locations for watershed simulations. If channel is supplied,
it also determines channel routing.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">overland_routing</span><span class="op">(</span></span>
<span>  <span class="va">r</span>,</span>
<span>  <span class="va">sf</span>,</span>
<span>  channel_flow_speed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  subwatersheds <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  max_overlap <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cell_neighbors</span><span class="op">(</span><span class="va">r</span>, <span class="va">sf</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-r">r<a class="anchor" aria-label="anchor" href="#arg-r"></a></dt>
<dd><p>An object of class <code><a href="https://rspatial.github.io/terra/reference/SpatRaster-class.html" class="external-link">SpatRaster</a></code>, defining the raster topology.</p></dd>


<dt id="arg-sf">sf<a class="anchor" aria-label="anchor" href="#arg-sf"></a></dt>
<dd><p>An object of class <code><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">sf</a></code> with the following columns:</p><ul><li><p><code>geometry</code>: Spatial point geometry corresponding to cell centers.</p></li>
<li><p><code>elevation</code>: Elevation above sea level (in m).</p></li>
<li><p><code>channel</code>: An optional logical (or binary) vector indicating cells corresponding to river channel.</p></li>
</ul></dd>


<dt id="arg-channel-flow-speed">channel_flow_speed<a class="anchor" aria-label="anchor" href="#arg-channel-flow-speed"></a></dt>
<dd><p>Average flow speed in the channel (in m/s).</p></dd>


<dt id="arg-subwatersheds">subwatersheds<a class="anchor" aria-label="anchor" href="#arg-subwatersheds"></a></dt>
<dd><p>A boolean flag to define watershed subunits.</p></dd>


<dt id="arg-max-overlap">max_overlap<a class="anchor" aria-label="anchor" href="#arg-max-overlap"></a></dt>
<dd><p>Maximum proportion of overlapping cells for watershed subunits to be considered independent. Lower values will normally produce larger subunits.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An object of class <code><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">sf</a></code> describing overland routing parameters and outlet cells:</p><ul><li><p><code>geometry</code>: Spatial point geometry corresponding to cell centers.</p></li>
<li><p><code>elevation</code>: Elevation above sea level (in m).</p></li>
<li><p><code>waterRank</code>: Ranked elevation in decreasing order.</p></li>
<li><p><code>waterOrder</code>: A vector with the cell's processing order for overland routing (based on elevation). First value corresponds to the row index of the first processed cell, second value corresponds to the row index of the second processed cell and so forth.</p></li>
<li><p><code>queenNeigh</code>: A list where, for each cell, a vector gives the identity of neighbours (up to eight).</p></li>
<li><p><code>waterQ</code>: A list where, for each cell, a vector gives the proportion of overland flow to each neighbour.</p></li>
<li><p><code>channel</code>: A logical vector indicating channel cells.</p></li>
<li><p><code>outlet</code>: A logical vector indicating outlet cells.</p></li>
<li><p><code>target_outlet</code>: Index of the outlet cell to which the channel leads  (<code>NA</code> for non-channel cells).</p></li>
<li><p><code>distance_to_outlet</code>: Distance to the target outlet in number of cells (<code>NA</code> for non-channel cells).</p></li>
<li><p><code>outlet_backlog</code>: For each outlet, a backlog vector of watershed export (<code>NA</code> for non-outlet cells).</p></li>
<li><p><code>subwatershed</code>: Integer vector indicating watershed subunits (<code>NA</code> if <code>subwatersheds = FALSE</code>).</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>If <code>channel</code> is not supplied, then cells where all neighbors are at higher elevation are considered outlet cells.
If <code>channel</code> is supplied, then outlets are channel cells in the domain limits and not having a neighbor channel at lower elevation. In this case,
model simulations will include channel routing towards outlet cells.</p>
<p>If defining watershed subunits is requested (i.e. if <code>subwatersheds = TRUE</code>), subunits are defined first by determining the area draining to each channel or outlet cell. Then, those areas are progressively merged if one is nested into the other or when the proportion of overlapping cells is lower than
a pre-specified threshold (i.e. larger than <code>max_overlap</code>). A given cell cannot belong to more than one subunit. Therefore, the overlap between the final subwatersheds is eliminated by deciding the main subwatershed for each cell, the proportion of overland flow to neighbors is modified for cells in located in subunit boundaries.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Load example watershed data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_watershed"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Get bounding box to determine limits</span></span></span>
<span class="r-in"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">example_watershed</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">b</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    xmin    ymin    xmax    ymax </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  401430 4671870  402830 4672570 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define a raster topology, using terra package, </span></span></span>
<span class="r-in"><span><span class="co"># with the same CRS as the watershed. In this example cells have 100 m side.</span></span></span>
<span class="r-in"><span><span class="co"># Coordinates in the 'sf' object are assumed to be cell centers</span></span></span>
<span class="r-in"><span><span class="va">r</span> <span class="op">&lt;-</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">401380</span>, ymin <span class="op">=</span> <span class="fl">4671820</span>, xmax <span class="op">=</span> <span class="fl">402880</span>, ymax <span class="op">=</span> <span class="fl">4672620</span>, </span></span>
<span class="r-in"><span>                nrow <span class="op">=</span> <span class="fl">8</span>, ncol <span class="op">=</span> <span class="fl">15</span>, crs <span class="op">=</span> <span class="st">"epsg:32631"</span><span class="op">)</span></span></span>
<span class="r-in"><span>                </span></span>
<span class="r-in"><span><span class="co"># Generate overland routing</span></span></span>
<span class="r-in"><span><span class="va">or</span> <span class="op">&lt;-</span> <span class="fu">overland_routing</span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot elevation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or</span><span class="op">[</span><span class="st">"elevation"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="overland_routing-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Rank (decreasing elevation) for processing</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or</span><span class="op">[</span><span class="st">"waterRank"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="overland_routing-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot outlet cells</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or</span><span class="op">[</span><span class="st">"outlet"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="overland_routing-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define 4-cell channel</span></span></span>
<span class="r-in"><span><span class="va">example_watershed</span><span class="op">$</span><span class="va">channel</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="va">example_watershed</span><span class="op">$</span><span class="va">channel</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">11</span>, <span class="fl">12</span>, <span class="fl">20</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Generate overland and channel routing</span></span></span>
<span class="r-in"><span><span class="va">or_channel</span> <span class="op">&lt;-</span> <span class="fu">overland_routing</span><span class="op">(</span><span class="va">r</span>, <span class="va">example_watershed</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot outlet and distance to outlet</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or_channel</span><span class="op">[</span><span class="st">"outlet"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">or_channel</span><span class="op">[</span><span class="st">"distance_to_outlet"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="overland_routing-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Miquel De Cáceres, Aitor Améztegui, María González, Núria Aquilué, Daniel Caviedes-Voullième, Mario Morales-Hernández.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

